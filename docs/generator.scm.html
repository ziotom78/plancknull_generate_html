<!doctype html>
<html>
<head>
<title>generator.scm</title>
<link rel="stylesheet" href="schematic.css" /></head>
<body>
<div id="background"></div>
<div id="container">
<table cellspacing="0" cellpadding="0">
<tr>
<th class="docs">
<h1>generator.scm</h1></th>
<th class="code"></th></tr>
<tr id="section-1">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-1">&para;</a></div><h1>Null test HTML report generator</h1>

<p>Generate a HTML page containing the results of a set of null tests.</p>

<p>Author: Maurizio Tomasi</p>

<p>Start date: August 13th, 2012</p>

<h1>How to generate the executable</h1>

<p>The program is written in Scheme
<a href="http://www.schemers.org/Documents/Standards/R5RS/">R5RS</a>, and it
needs to be compiled into an executable in order to be executed.
There are two ways to do it: either grab a precompiled binary (easy
way) or compile it by yourself (hard way). In the following section
we'll detail the two procedures.</p>

<h2>Grabbing the executable (easy way)</h2>

<p>You can ask Maurizio Tomasi for a self-contained bundle. At the LFI
DPC and at NERSC, he keeps one in his homedir. The bundle is a
directory containing the executable (named <code>standalone_generator</code>)
and a large set of dynamic libraries needed to run the program. You
can move this directory anywhere in your filesystem, but do not try
to run it on different architectures/distributions (e.g. from a
RedHat system to Ubuntu, from x86 to x86_64...).</p>

<h2>Compiling the executable from the source (hard way)</h2>

<p>To compile the source code into an executable you must have the
<a href="http://www.call-cc.org/">Chicken Scheme</a> compiler and a few
open-source libraries for Chicken (called
<a href="http://wiki.call-cc.org/eggs"><em>eggs</em></a>). To install Chicken, you
can use your package manager (e.g. <code>sudo apt-get install
chicken-bin</code> under Ubuntu Linux) if you are a <code>sudo</code> user.
Otherwise, you must install it from source in your home directory.
Open a terminal and run the following commands (if you do not see
the second line fully, select the text with the mouse):</p>

<pre><code>mkdir -p $HOME/usr $HOME/.chicken-temp
curl http://code.call-cc.org/releases/current/chicken.tar.gz | tar xz -C $HOME/.chicken-temp
pushd $HOME/.chicken-temp/chicken-*
make PLATFORM=linux PREFIX=$HOME/usr install
popd
rm -rf $HOME/.chicken-temp
</code></pre>

<p>(If you want, you can change <code>$HOME/usr</code> with any other directory
you want. It should be the place where you usually install things
under your home directory.) At this point, if you did not so
already, put the following lines at the end of your <code>~/.profile</code>
(assuming you're using <code>sh</code>, <code>bash</code> or <code>dash</code> as your login shell):</p>

<pre><code>export PATH=$HOME/usr/bin:$PATH
export C_INCLUDE_PATH=$HOME/usr/include:$C_INCLUDE_PATH
export LIBRARY_PATH=$HOME/usr/lib:$LIBRARY_PATH
export LD_LIBRARY_PATH=$HOME/usr/lib:$LD_LIBRARY_PATH
export MANPATH=$HOME/usr/man:$MANPATH
</code></pre>

<p>Logout and login to see the new variabiles. If you are able to run
<code>chicken -version</code>, then the installation of the compiler
completed successfully.</p>

<p>Now you need some "eggs" (that is, Chicken's libraries). Move to
the directory where you have the source code of
<code>plancknull_generate_html</code> and run the following command:</p>

<pre><code>sudo make install_eggs
</code></pre>

<p>(If you've installed Chicken under your homedir, omit <code>sudo</code>). Now
you should be able to compile the program, simply run</p>

<pre><code>make generator
</code></pre>

<p>This will silently convert <code>generator.scm</code> into a C program, which
will then be compiled to a standalone executable. The <code>Makefile</code>
provided with the source code allows for many targets, run <code>make
TARGET</code> where <code>TARGET</code> is one of the following:</p>

<ul>
<li><code>generator</code> produces the executable. Be careful that this program
needs the Chicken runtime libraries to be accessible at runtime
(therefore you cannot distribute it)</li>
<li><code>deploy</code> produces a stand-alone executable in the directory
<code>standalone_generator</code>. Unlike the <code>generator</code> target, the content
of the directory (containing the executable <code>standalone_generator</code>
plus many dynamic libraries) <em>can</em> be distributed to others, as all
the Chicken libraries needed by the program are included in the
directory. (You can think of it as Chicken's analogous to Mac OS X
<code>.app</code> directories.)</li>
<li><code>install_eggs</code> repeatedly calls <code>chicken-install</code> to install the
eggs required to compile the program. You might have to use <code>sudo</code>
(e.g. this is the case if you installed Chicken using Ubuntu's
<code>apt-get</code>).</li>
<li><code>documentation</code> runs Schematic on the source code to produce this
documentation (in the <code>docs</code> directory).</li>
<li><code>help</code> prints a summary of the available options implemented in
the makefile.</li>
</ul>

<h1>How to run the program</h1>

<p>To run the program, you must have
<a href="http://healpix.jpl.nasa.gov/html/facilitiesnode9.htm"><code>map2tga</code></a>
and <code>convert</code> (part of
<a href="http://www.imagemagick.org/script/index.php">ImageMagick</a> &mdash;
its fork <a href="http://www.graphicsmagick.org/">GraphicsMagick</a> should be
ok as well) in your path. <code>map2tga</code> is provided by
<a href="http://healpix.jpl.nasa.gov/">Healpix</a>: if you work with
Planck/LFI, you surely have it. (Note that it is already installed
at the LFI DPC.)</p>

<p>The program needs as input one or more JSON files containing
information about the products of the null tests. Typically, these
are produced by the
<a href="https://github.com/zonca/plancknull"><code>plancknull</code></a> program. You
can specify them from the command line:</p>

<pre><code>$ generator NULL_TEST_DIRECTORY OUTPUT_PATH
</code></pre>

<p>(If you are using the standalone executable, run
<code>standalone_generator</code> instead of <code>generator</code>). This will read the
results of the null tests from the subdirectories under
<code>NULL_TEST_DIRECTORY</code>, and it will create the directory
<code>OUTPUT_PATH</code> and populate it with the files needed for the HTML
report. If <code>OUTPUT_PATH</code> does not exist, it will be silently
created.</p>

<h1>How to read the source code of this program</h1>

<p>This page was created automatically from the program source code
using <a href="http://wiki.call-cc.org/eggref/4/schematic"><code>schematic</code></a>, a
documenting tool for Chicken Scheme. Install it from the command
line with the command <code>sudo chicken-install schematic</code>, then
run</p>

<pre><code>schematic -f markdown generator.scm
</code></pre>

<p>(assuming you have
<a href="http://en.wikipedia.org/wiki/Markdown"><code>markdown</code></a>, which can be
easily installed using <code>apt-get</code> under Debian/Ubuntu). This will
create a sub-directory <code>html</code> where you'll find the source code of
this very webpage.</p>
</td>
<td class="code">
<pre class="highlight">
</pre></td></tr>
<tr id="section-2">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-2">&para;</a></div><h1>Initialization</h1>
</td>
<td class="code">
<pre class="highlight">
</pre></td></tr>
<tr id="section-3">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-3">&para;</a></div><p>We need the <code>json</code> egg in order to load the database of null test
results written by the Python script. The <code>html-tags</code> and
<code>html-utils</code> eggs are very useful to generate HTML from code, much
in the same way as described in Paul Graham's 16th chapter of <a href="http://www.paulgraham.com/acl.html">ANSI
Common LISP</a>. The <code>shell</code> egg
is used to call <code>map2gif</code>. The eggs <code>filepath</code> and
<code>directory-utils</code> are used respectively to manipulate file paths
and to create/modify the directory structure of a file system (we
are going to use it to create the tree of directories that will
contain the HTML report). SRFI-19 implements a set of functions to
deal with date and times. We use it to put timestamps in the
report.</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default">require-extension json</span>)</span>
<span class="paren1">(<span class="default">require-extension html-tags</span>)</span>
<span class="paren1">(<span class="default">require-extension html-utils</span>)</span>
<span class="paren1">(<span class="default">require-extension shell</span>)</span>
<span class="paren1">(<span class="default">require-extension filepath</span>)</span>
<span class="paren1">(<span class="default">require-extension directory-utils</span>)</span>
<span class="paren1">(<span class="default">require-extension srfi-19</span>)</span>

</pre></td></tr>
<tr id="section-4">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-4">&para;</a></div><p>We're going to concatenate a number of HTML statements, so it is
nicer to have a shorthand for the Scheme function
<code>string-concatenate</code>. Note that Scheme identifiers can include
symbols as well, not only letters and numbers.</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> html:++ string-concatenate</span>)</span>

</pre></td></tr>
<tr id="section-5">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-5">&para;</a></div><p>Since JSON entries are going to be handled as <em>a-lists</em>
(<a href="http://en.wikipedia.org/wiki/Association_list">association
lists</a>), we'll often
use a nice shorthand which is not provided by standard Scheme (note
however that <code>assq-ref</code> is a
<a href="http://www.gnu.org/software/guile/manual/html_node/Retrieving-Alist-Entries.html">built-in</a>
in GNU Guile, but - alas! - not in Chicken Scheme).</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> <span class="paren2">(<span class="default">assq-ref entry a-list</span>)</span> <span class="paren2">(<span class="default">cdr <span class="paren3">(<span class="default">assq entry a-list</span>)</span></span>)</span></span>)</span>

</pre></td></tr>
<tr id="section-6">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-6">&para;</a></div><h1>JSON parsing</h1>
</td>
<td class="code">
<pre class="highlight">
</pre></td></tr>
<tr id="section-7">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-7">&para;</a></div><p>The <code>json-read</code> function returns a vector of pairs of the form
<code>(string . value)</code> (with <code>string</code> being the key). However, this is
not the best representation for the data. First of all, when
looking for a specific key it is much faster to work with symbols
than with strings. Also, in order to use the built-in Scheme
function <code>assq</code> we need to have lists, not vectors. The function
<code>json-&gt;alist</code> performs these two conversions, by means of
<code>string-&gt;symbol</code> and <code>vector-&gt;list</code> (two Scheme built-ins).</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> <span class="paren2">(<span class="default">json-&gt;alist dictionary</span>)</span>
  <span class="paren2">(<span class="default">map <span class="paren3">(<span class="default"><i><span class="symbol">lambda</span></i> <span class="paren4">(<span class="default">x</span>)</span>
	 <span class="paren4">(<span class="default">cons <span class="paren5">(<span class="default">string-&gt;symbol <span class="paren6">(<span class="default">car x</span>)</span></span>)</span>
	       <span class="paren5">(<span class="default">cdr x</span>)</span></span>)</span></span>)</span>
       <span class="paren3">(<span class="default">vector-&gt;list dictionary</span>)</span></span>)</span></span>)</span>

</pre></td></tr>
<tr id="section-8">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-8">&para;</a></div><h1>Command-line parsing</h1>
</td>
<td class="code">
<pre class="highlight">
</pre></td></tr>
<tr id="section-9">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-9">&para;</a></div><p>Here we implement the code that will read the JSON files from the
command-line and merge them into one big list of dictionaries
(a-lists).</p>
</td>
<td class="code">
<pre class="highlight">
</pre></td></tr>
<tr id="section-10">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-10">&para;</a></div><p>If <code>args</code> is the list of command-line arguments provided to the
program, function <code>parse-command-line</code> analyzes them and returns an
associative list containing the following fields: <code>'output-dir</code> is
a string specifying the directory where to save the report,
<code>'input-dir</code> is a string containing the path where to look for JSON
files.</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> <span class="paren2">(<span class="default">parse-command-line program-name args</span>)</span>
  <span class="paren2">(<span class="default"><i><span class="symbol">if</span></i> <span class="paren3">(<span class="default">not <span class="paren4">(<span class="default">eq? <span class="paren5">(<span class="default">length args</span>)</span> 2</span>)</span></span>)</span>
      <span class="paren3">(<span class="default">begin <span class="paren4">(<span class="default">format #t #&lt;&lt;EOF
<span class="keyword">Usage:</span> ~a NULL_TEST_DIR OUTPUT_PATH

where NULL_TEST_DIR is <i><span class="symbol">the</span></i> path to <i><span class="symbol">the</span></i> directory containing
<i><span class="symbol">the</span></i> results of <i><span class="symbol">the</span></i> null tests to be included in <i><span class="symbol">the</span></i> report,
and OUTPUT_PATH is <i><span class="symbol">the</span></i> path where to save <i><span class="symbol">the</span></i> files of <i><span class="symbol">the</span></i>
HTML report. If OUTPUT_PATH does not exist, it will be created.
EOF
		      program-name</span>)</span>
	     <span class="paren4">(<span class="default">exit 1</span>)</span></span>)</span></span>)</span>
  <span class="paren2">(<span class="default">list <span class="paren3">(<span class="default">cons &#x27;input-dir <span class="paren4">(<span class="default">car args</span>)</span></span>)</span>
	<span class="paren3">(<span class="default">cons &#x27;output-dir <span class="paren4">(<span class="default">cadr args</span>)</span></span>)</span></span>)</span></span>)</span>

</pre></td></tr>
<tr id="section-11">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-11">&para;</a></div><p>The variable <code>user-args</code> holds all the information the user
specified from the command line. Note that <code>argv</code> (function, not
variable!) is not part of R5RS: it is a Chicken extension.</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> user-args <span class="paren2">(<span class="default">parse-command-line <span class="paren3">(<span class="default">car <span class="paren4">(<span class="default">argv</span>)</span></span>)</span>
				      <span class="paren3">(<span class="default">cdr <span class="paren4">(<span class="default">argv</span>)</span></span>)</span></span>)</span></span>)</span>

<span class="paren1">(<span class="default">format #t <span class="string">&quot;Report will be created under the following path: ~a</span><span class="string">\n</span><span class="string">&quot;</span>
	<span class="paren2">(<span class="default">assq-ref &#x27;output-dir user-args</span>)</span></span>)</span>
<span class="paren1">(<span class="default">format #t <span class="string">&quot;Directory where to look for JSON files: ~a</span><span class="string">\n</span><span class="string">&quot;</span>
	<span class="paren2">(<span class="default">assq-ref &#x27;input-dir user-args</span>)</span></span>)</span>

</pre></td></tr>
<tr id="section-12">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-12">&para;</a></div><p>Parse a file and return a list of associative lists suitable for
being used with functions like <code>assq</code> and <code>assv</code>. Note that, unlike
<code>json-read</code>, this function returns a list even if the JSON file
contains just one object: this is done through the <code>(if (list?
...))</code>.</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> <span class="paren2">(<span class="default">extract-alists-from-json-file file-name</span>)</span>
  <span class="paren2">(<span class="default">format #t <span class="string">&quot;Reading file ~a...</span><span class="string">\n</span><span class="string">&quot;</span> file-name</span>)</span>
  <span class="paren2">(<span class="default"><i><span class="symbol">let</span></i> <span class="paren3">(<span class="default"><span class="paren4">(<span class="default">entries <span class="paren5">(<span class="default">call-with-input-file file-name json-read</span>)</span></span>)</span></span>)</span>
    <span class="paren3">(<span class="default">map json-&gt;alist <span class="paren4">(<span class="default"><i><span class="symbol">if</span></i> <span class="paren5">(<span class="default">list? entries</span>)</span> entries <span class="paren5">(<span class="default">list entries</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>

</pre></td></tr>
<tr id="section-13">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-13">&para;</a></div><p>Find all the files in the null test directory and read their
contents, then assemble all the objects (a-lists) into a list
(using <code>extract-alists-from-json-file</code>). Note that <code>append</code> is not
a R5RS built-in (it is part of
<a href="http://srfi.schemers.org/srfi-1/srfi-1.html">SRFI-1</a>), but Chicken
incorporates it. Also, <code>find-files</code> is part of the Chicken <code>posix</code>
library, and it accepts regular expressions to match the files (the
meaning of <code>.+\\.json$</code> is: a sequence of N>0 characters which ends
with <code>.json</code>).</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> json-dictionary
  <span class="paren2">(<span class="default">apply append <span class="paren3">(<span class="default">map extract-alists-from-json-file
		     <span class="paren4">(<span class="default">find-files <span class="paren5">(<span class="default">assq-ref &#x27;input-dir user-args</span>)</span>
				 <span class="string">&quot;.+</span><span class="string">\\</span><span class="string">.json$&quot;</span></span>)</span></span>)</span></span>)</span></span>)</span>

</pre></td></tr>
<tr id="section-14">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-14">&para;</a></div><p>The function <code>filter-on-filetype</code> filters the contents of
<code>json-dictionary</code> acc ording to a given file type. The use of
<code>filter</code> is exactly the same as in Python.</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> <span class="paren2">(<span class="default">filter-on-filetype file-type</span>)</span>
  <span class="paren2">(<span class="default">filter <span class="paren3">(<span class="default"><i><span class="symbol">lambda</span></i> <span class="paren4">(<span class="default">object</span>)</span>
	    <span class="paren4">(<span class="default">equal? <span class="paren5">(<span class="default">assq-ref &#x27;file_type object</span>)</span>
		    file-type</span>)</span></span>)</span>
	  json-dictionary</span>)</span></span>)</span>

</pre></td></tr>
<tr id="section-15">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-15">&para;</a></div><h1>GIF generation</h1>
</td>
<td class="code">
<pre class="highlight">
</pre></td></tr>
<tr id="section-16">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-16">&para;</a></div><p>We need to implement the code that will convert the maps in FITS
format into GIF images that can be included in the HTML report. We
assume the availability of the <code>map2gif</code> program bundled with
<a href="http://healpix.jpl.nasa.gov/">Healpix</a>.</p>
</td>
<td class="code">
<pre class="highlight">
</pre></td></tr>
<tr id="section-17">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-17">&para;</a></div><p>Note that, since <code>map2gif</code> does not overwrite existing GIF files,
if the file already exists and the flag <code>overwrite?</code> is true we
first need to delete the file.</p>
</td>
<td class="code">
<pre class="highlight">
<span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> <span class="paren2">(<span class="default">map2gif input-fits-file-name
		 output-gif-file-name
		 title
		 #!key <span class="paren3">(<span class="default">overwrite? #f</span>)</span></span>)</span> <span class="comment">; If not specified, it is #f
</span>  <span class="paren2">(<span class="default">call/cc <span class="comment">; Chicken&#x27;s shortcut for call-with-current-continuation
</span>   <span class="paren3">(<span class="default"><i><span class="symbol">lambda</span></i> <span class="paren4">(<span class="default">return</span>)</span>
     <span class="paren4">(<span class="default"><i><span class="symbol">if</span></i> <span class="paren5">(<span class="default">file-exists? output-gif-file-name</span>)</span>
	 <span class="paren5">(<span class="default"><i><span class="symbol">if</span></i> overwrite?
	     <span class="paren6">(<span class="default">delete-file output-gif-file-name</span>)</span>
	     <span class="paren6">(<span class="default">return &#x27;<span class="paren1">(<span class="default"></span>)</span></span>)</span></span>)</span></span>)</span>
</span></span></span></span></span></span></pre></td></tr>
<tr id="section-18">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-18">&para;</a></div><p>Create the directory that will contain the output file,
if it does not exist</p>
</td>
<td class="code">
<pre class="highlight">     <span class="paren1">(<span class="default">create-pathname-directory output-gif-file-name</span>)</span>
</pre></td></tr>
<tr id="section-19">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-19">&para;</a></div><p>Run the program. Note the elegance of "run<em>" (from the "shell"
egg): we include the command-line switches as if they were
Scheme symbols! (We put a comma in front of <code>(html:++ ...)</code>
because we want it to be interpreted as a Scheme expression:
otherwise it would be put as it is in the arguments to the
process call.) *Note:</em> <code>run*</code> is defined in the <code>shell</code> egg.
When multiple commands are specified (in this case, <code>map2tga</code>
and <code>convert</code>), it returns a set of values. These must be
interpreted using <code>call-with-values</code>, which is a standard
Scheme function accepting a "producer" and a "consumer". Refer
to the <a href="http://wiki.call-cc.org/man/4/The%20R5RS%20standard#control-features">R5RS
documentation</a>
for further details.</p>
</td>
<td class="code">
<pre class="highlight">     <span class="paren1">(<span class="default"><i><span class="symbol">let</span></i> <span class="paren2">(<span class="default"><span class="paren3">(<span class="default">output-tga-file-name
	    <span class="paren4">(<span class="default">filepath:replace-extension output-gif-file-name <span class="string">&quot;.tga&quot;</span></span>)</span></span>)</span></span>)</span>
       <span class="paren2">(<span class="default">call-with-values
	   <span class="paren3">(<span class="default"><i><span class="symbol">lambda</span></i> <span class="paren4">(<span class="default"></span>)</span>
	     <span class="paren4">(<span class="default">format #t <span class="string">&quot;Running map2tga and convert on ~a...</span><span class="string">\n</span><span class="string">&quot;</span>
		     input-fits-file-name</span>)</span>
	     <span class="paren4">(<span class="default">run* <span class="paren5">(<span class="default">map2tga ,input-fits-file-name
			    ,output-tga-file-name
			    -bar
			    -xsz 640
			    -title ,<span class="paren6">(<span class="default">html:++ <span class="paren1">(<span class="default">list <span class="string">&quot;</span><span class="string">\&quot;</span><span class="string">&quot;</span> title <span class="string">&quot;</span><span class="string">\&quot;</span><span class="string">&quot;</span></span>)</span></span>)</span></span>)</span>
		   <span class="paren5">(<span class="default">convert ,output-tga-file-name
			    -transparent white
			    ,output-gif-file-name</span>)</span></span>)</span></span>)</span>
	 <span class="paren3">(<span class="default"><i><span class="symbol">lambda</span></i> <span class="paren4">(<span class="default">map2tga-return-code convert-return-code</span>)</span>
	   <span class="paren4">(<span class="default"><i><span class="symbol">if</span></i> <span class="paren5">(<span class="default">&gt; map2tga-return-code 0</span>)</span>
	       <span class="paren5">(<span class="default">abort <span class="string">&quot;Error when executing </span><span class="string">\&quot;</span><span class="string">map2tga</span><span class="string">\&quot;</span><span class="string">&quot;</span></span>)</span></span>)</span>
	   <span class="paren4">(<span class="default"><i><span class="symbol">if</span></i> <span class="paren5">(<span class="default">&gt; convert-return-code 0</span>)</span>
	       <span class="paren5">(<span class="default">abort <span class="string">&quot;Error when executing </span><span class="string">\&quot;</span><span class="string">convert</span><span class="string">\&quot;</span><span class="string">&quot;</span></span>)</span></span>)</span></span>)</span></span>)</span>
       <span class="paren2">(<span class="default">delete-file output-tga-file-name</span>)</span></span>)</span>)))

</pre></td></tr>
<tr id="section-20">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-20">&para;</a></div><p>This function converts the name of a FITS file containing a map
into the name of the <code>.gif</code> file that will contain the
representation of the map shown in the report. It strips the
directory and extension parts and substitutes them using functions
from the <code>filepath</code> eggs. Note that we want the GIF file to be in a
subdirectory of the output directory instead of being in the same
directory as the input FITS file: in this was the user can run
<code>tar</code> or <code>zip</code> on it to obtain a self-contained report.</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> <span class="paren2">(<span class="default">fits-name-&gt;gif-name fits-name</span>)</span>
  <span class="paren2">(<span class="default">filepath:replace-directory
   <span class="paren3">(<span class="default">filepath:replace-extension fits-name <span class="string">&quot;.gif&quot;</span></span>)</span>
   <span class="string">&quot;images&quot;</span></span>)</span></span>)</span>

</pre></td></tr>
<tr id="section-21">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-21">&para;</a></div><h1>Report generation</h1>
</td>
<td class="code">
<pre class="highlight">
</pre></td></tr>
<tr id="section-22">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-22">&para;</a></div><h2>Copying common files</h2>

<p>A small set of files (CSS styles, JavaScript files) need to be
copied to the output directory, in order to make the report
self-contained. These files should be taken from the directory
where the executable has been launched.</p>
</td>
<td class="code">
<pre class="highlight">
</pre></td></tr>
<tr id="section-23">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-23">&para;</a></div><p>Chicken Scheme does not provide a function to copy whole
directories. So we implement one using a nice function implemented
in <code>directory-utils</code>: <code>directory-fold</code>. It takes a function to be
applied to each file, a user-defined value that is passed to this
function (we do not use it, so we call it <code>unused</code> and set it to
<code>#f</code>) and the name of the directory.</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> <span class="paren2">(<span class="default">dir-copy source dest</span>)</span>
  <span class="paren2">(<span class="default">directory-fold
   <span class="paren3">(<span class="default"><i><span class="symbol">lambda</span></i> <span class="paren4">(<span class="default">filename unused</span>)</span>
     <span class="paren4">(<span class="default"><i><span class="symbol">let</span></i> <span class="paren5">(<span class="default"><span class="paren6">(<span class="default">output-file <span class="paren1">(<span class="default">filepath:join-path <span class="paren2">(<span class="default">list dest filename</span>)</span></span>)</span></span>)</span></span>)</span>
       <span class="paren5">(<span class="default">format #t <span class="string">&quot;Copying file ~a to ~a...</span><span class="string">\n</span><span class="string">&quot;</span> filename dest</span>)</span>
</span></span></span></span></span></span></span></span></pre></td></tr>
<tr id="section-24">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-24">&para;</a></div><p>Create the destination directory if it does not exist</p>
</td>
<td class="code">
<pre class="highlight">       <span class="paren1">(<span class="default">create-pathname-directory output-file</span>)</span>
</pre></td></tr>
<tr id="section-25">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-25">&para;</a></div><p>Copy the file. <code>file_copy</code> is part of Chicken Scheme</p>
</td>
<td class="code">
<pre class="highlight">       <span class="paren1">(<span class="default">file-copy <span class="paren2">(<span class="default">filepath:join-path <span class="paren3">(<span class="default">list source filename</span>)</span></span>)</span>
		  output-file
		  &#x27;overwrite</span>)</span>))
   #f <span class="comment">; This is our value for `unused`
</span>   source))

</pre></td></tr>
<tr id="section-26">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-26">&para;</a></div><p>Now we can iterate over the names of the directories to be copied
(currently only <code>css</code>, but a separate directory <code>js</code> for JavaScript
files might be needed in the future).</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default"><i><span class="symbol">let</span></i> <span class="paren2">(<span class="default"><span class="paren3">(<span class="default">source-dir <span class="paren4">(<span class="default">filepath:take-directory <span class="paren5">(<span class="default">car <span class="paren6">(<span class="default">argv</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>
  <span class="paren2">(<span class="default">for-each
   <span class="paren3">(<span class="default"><i><span class="symbol">lambda</span></i> <span class="paren4">(<span class="default">dir-name</span>)</span>
     <span class="paren4">(<span class="default">dir-copy <span class="paren5">(<span class="default">filepath:join-path <span class="paren6">(<span class="default">list source-dir dir-name</span>)</span></span>)</span>
	       <span class="paren5">(<span class="default">filepath:join-path <span class="paren6">(<span class="default">list <span class="paren1">(<span class="default">assq-ref &#x27;output-dir user-args</span>)</span>
					 dir-name</span>)</span></span>)</span></span>)</span></span>)</span>
   <span class="paren3">(<span class="default">list <span class="string">&quot;css&quot;</span></span>)</span></span>)</span></span>)</span>

</pre></td></tr>
<tr id="section-27">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-27">&para;</a></div><h2>General-purpose functions</h2>

<p>We keep the names of the HTML files to be created in a alist for
avoiding repetitions in the code (they must be used when creating
the files and when producing the <code>&lt;a&gt;</code> links in the side menu). The
function <code>get-html-file-name</code> is the only access function we need
for this alist, so we make <code>html-file-name</code> a local definition.</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> <span class="paren2">(<span class="default">get-html-file-name label</span>)</span>
  <span class="paren2">(<span class="default"><i><span class="symbol">let</span></i> <span class="paren3">(<span class="default"><span class="paren4">(<span class="default">html-file-names
	 &#x27;<span class="paren5">(<span class="default"><span class="paren6">(<span class="default">information . <span class="string">&quot;index.html&quot;</span></span>)</span>
	   <span class="paren6">(<span class="default">halfring-frequency . <span class="string">&quot;halfring_freq.html&quot;</span></span>)</span>
	   <span class="paren6">(<span class="default">surv-rad . <span class="string">&quot;surv_radiometer.html&quot;</span></span>)</span>
	   <span class="paren6">(<span class="default">surv-horn . <span class="string">&quot;surv_horn.html&quot;</span></span>)</span>
	   <span class="paren6">(<span class="default">surv-pair . <span class="string">&quot;surv_pair.html&quot;</span></span>)</span>
	   <span class="paren6">(<span class="default">surv-frequency . <span class="string">&quot;surv_freq.html&quot;</span></span>)</span>
	   <span class="paren6">(<span class="default">surv-cross-freq . <span class="string">&quot;surv_cross.html&quot;</span></span>)</span>
	   <span class="paren6">(<span class="default">full-pair . <span class="string">&quot;full_pair.html&quot;</span></span>)</span>
	   <span class="paren6">(<span class="default">full-frequency . <span class="string">&quot;full_freq.html&quot;</span></span>)</span>
	   <span class="paren6">(<span class="default">full-cross-freq . <span class="string">&quot;full_cross.html&quot;</span></span>)</span>
	   <span class="paren6">(<span class="default">table-of-contents . <span class="string">&quot;toc.html&quot;</span></span>)</span></span>)</span></span>)</span></span>)</span>
    <span class="paren3">(<span class="default">assq-ref label html-file-names</span>)</span></span>)</span></span>)</span>

</pre></td></tr>
<tr id="section-28">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-28">&para;</a></div><p>Each HTML page contains a menu on the left, whose look is specified
by the CSS file <code>css/menu.css</code>. Note how nice is to use the
<code>html-tag</code> package: we are producing HTML code using commands like
<code>&lt;a&gt;</code> just in plain HTML, yet we can freely call Scheme functions
within it (in this case, <code>get-html-file-name</code>). We define a
<code>smart-&lt;a&gt;</code> function which uses <code>get-html-file-name</code> to retrieve
the link to be used in the <code>&lt;a&gt;</code> tag, and it also defines the class
according to the fact that the entry links to its own page or not
(the CSS style uses this to highlight selected items in bold).</p>

<p>Note that we implement a local function named <code>smart-&lt;a&gt;</code>. Its
purpose is to produce a link to a page, which is of the class
"selected" if the page to be linked is the same page we are
generating.</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> <span class="paren2">(<span class="default">side-menu page</span>)</span>
  <span class="paren2">(<span class="default"><i><span class="symbol">let</span></i> <span class="paren3">(<span class="default"><span class="paren4">(<span class="default">smart-&lt;a&gt; <span class="paren5">(<span class="default"><i><span class="symbol">lambda</span></i> <span class="paren6">(<span class="default">title tag</span>)</span>
		     <span class="paren6">(<span class="default">&lt;a&gt; <span class="keyword">href:</span> <span class="paren1">(<span class="default">get-html-file-name tag</span>)</span>
			  <span class="keyword">class:</span> <span class="paren1">(<span class="default"><i><span class="symbol">if</span></i> <span class="paren2">(<span class="default">eq? tag page</span>)</span>
				     <span class="string">&quot;selected&quot;</span>
				     <span class="string">&quot;unselected&quot;</span></span>)</span>
			  title</span>)</span></span>)</span></span>)</span></span>)</span>
    <span class="paren3">(<span class="default">&lt;nav&gt; <span class="keyword">id:</span> <span class="string">&quot;nav&quot;</span>
	   <span class="paren4">(<span class="default">&lt;ul&gt; <span class="keyword">id:</span> <span class="string">&quot;menu&quot;</span>
		 <span class="paren5">(<span class="default">&lt;li&gt; <span class="paren6">(<span class="default">smart-&lt;a&gt; <span class="string">&quot;Information&quot;</span> &#x27;information</span>)</span></span>)</span>
		 <span class="paren5">(<span class="default">&lt;li&gt; <span class="string">&quot;1-h tests (half rings) &amp;raquo;&quot;</span>
		       <span class="paren6">(<span class="default">&lt;ul&gt; <span class="paren1">(<span class="default">smart-&lt;a&gt; <span class="string">&quot;Frequency&quot;</span> &#x27;halfring-frequency</span>)</span></span>)</span></span>)</span>
		 <span class="paren5">(<span class="default">&lt;li&gt; <span class="string">&quot;Survey tests &amp;raquo;&quot;</span>
		       <span class="paren6">(<span class="default">&lt;ul&gt;
			<span class="paren1">(<span class="default">&lt;li&gt; <span class="paren2">(<span class="default">smart-&lt;a&gt; <span class="string">&quot;Single radiometer&quot;</span> &#x27;surv-rad</span>)</span></span>)</span>
			<span class="paren1">(<span class="default">&lt;li&gt; <span class="paren2">(<span class="default">smart-&lt;a&gt; <span class="string">&quot;Single horn&quot;</span> &#x27;surv-horn</span>)</span></span>)</span>
			<span class="paren1">(<span class="default">&lt;li&gt; <span class="paren2">(<span class="default">smart-&lt;a&gt; <span class="string">&quot;Horn pair&quot;</span> &#x27;surv-pair</span>)</span></span>)</span>
			<span class="paren1">(<span class="default">&lt;li&gt; <span class="paren2">(<span class="default">smart-&lt;a&gt; <span class="string">&quot;Frequency&quot;</span> &#x27;surv-frequency</span>)</span></span>)</span>
			<span class="paren1">(<span class="default">&lt;li&gt; <span class="paren2">(<span class="default">smart-&lt;a&gt; <span class="string">&quot;Cross-frequency&quot;</span> &#x27;surv-cross-freq</span>)</span></span>)</span></span>)</span></span>)</span>
		 <span class="paren5">(<span class="default">&lt;li&gt; <span class="string">&quot;Full-mission tests &amp;raquo;&quot;</span>
		       <span class="paren6">(<span class="default">&lt;ul&gt;
			<span class="paren1">(<span class="default">&lt;li&gt; <span class="paren2">(<span class="default">smart-&lt;a&gt; <span class="string">&quot;Horn pair&quot;</span> &#x27;full-pair</span>)</span></span>)</span>
			<span class="paren1">(<span class="default">&lt;li&gt; <span class="paren2">(<span class="default">smart-&lt;a&gt; <span class="string">&quot;Frequency&quot;</span> &#x27;full-frequency</span>)</span></span>)</span>
			<span class="paren1">(<span class="default">&lt;li&gt; <span class="paren2">(<span class="default">smart-&lt;a&gt; <span class="string">&quot;Cross-frequency&quot;</span> &#x27;full-cross-freq</span>)</span></span>)</span></span>)</span></span>)</span>
		 <span class="paren5">(<span class="default">&lt;li&gt; <span class="paren6">(<span class="default">smart-&lt;a&gt; <span class="string">&quot;Table of contents&quot;</span> &#x27;table-of-contents</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>


</pre></td></tr>
<tr id="section-29">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-29">&para;</a></div><p>This is the name of the data release. <em>TODO</em>: make the release name
specifiable from the command line/configuration file</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> test-release-name <span class="string">&quot;DX9&quot;</span></span>)</span>

</pre></td></tr>
<tr id="section-30">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-30">&para;</a></div><p>The function <code>make-title-for-report</code> makes up the title for the
overall report, which is going to be repeated at the beginning of
each HTML page. It does so by prepending the name of the data
release to the title itself (in the parameter <code>string</code>). We want to
put the name of the release (e.g. <code>DX9</code>) at the beginning, so it
will be shown by tabbed browsers like Chrome even when a lot of
tabs are opened.</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> <span class="paren2">(<span class="default">make-title-for-report</span>)</span>
  <span class="paren2">(<span class="default">format #f <span class="string">&quot;~a null tests&quot;</span> test-release-name</span>)</span></span>)</span>

</pre></td></tr>
<tr id="section-31">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-31">&para;</a></div><p>The function <code>wrap-html</code> takes a string containing some HTML code
and encloses it in a self-contained HTML structure which comprises
the side menu. It returns a string.</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> <span class="paren2">(<span class="default">wrap-html file-tag page-title body</span>)</span>
  <span class="paren2">(<span class="default">html-page <span class="paren3">(<span class="default">html:++ <span class="paren4">(<span class="default">list
		       <span class="paren5">(<span class="default">&lt;h1&gt; <span class="paren6">(<span class="default">make-title-for-report</span>)</span></span>)</span>
		       <span class="paren5">(<span class="default">side-menu file-tag</span>)</span>
		       <span class="paren5">(<span class="default">&lt;div&gt; <span class="keyword">id:</span> <span class="string">&quot;body&quot;</span>
			      <span class="paren6">(<span class="default">&lt;h2&gt; page-title</span>)</span>
			      body</span>)</span></span>)</span></span>)</span>
	     <span class="keyword">title:</span> page-title
	     <span class="keyword">css:</span> &#x27;<span class="paren3">(<span class="default"><span class="string">&quot;css/main.css&quot;</span> <span class="string">&quot;css/menu.css&quot;</span></span>)</span></span>)</span></span>)</span>

</pre></td></tr>
<tr id="section-32">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-32">&para;</a></div><p>We are going to create a number of HTML files, and the creation of
each of them follows the same rules:</p>

<ol>
<li>Determine the name of the file using <code>get-html-file-name</code></li>
<li>Ensure that the directory where this file will be written exists</li>
<li>Inform the user about the pathname of the file we are going to
write</li>
<li>Write the file.</li>
</ol>

<p>Function <code>write-html</code> wraps all of this into one function. The
parameter <code>file-tag</code> is passed to <code>get-html-file-name</code> as it is,
while <code>write-function</code> is a function accepting as its unique
parameter the output stream to be used to write into the file.</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> <span class="paren2">(<span class="default">write-html file-tag write-function</span>)</span>
  <span class="paren2">(<span class="default"><i><span class="symbol">let</span></i> <span class="paren3">(<span class="default"><span class="paren4">(<span class="default">output-file-name <span class="paren5">(<span class="default">filepath:join-path
			   <span class="paren6">(<span class="default">list <span class="paren1">(<span class="default">assq-ref &#x27;output-dir user-args</span>)</span>
				 <span class="paren1">(<span class="default">get-html-file-name file-tag</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>
    <span class="paren3">(<span class="default">create-pathname-directory output-file-name</span>)</span>
    <span class="paren3">(<span class="default">format #t <span class="string">&quot;Writing file ~a...</span><span class="string">\n</span><span class="string">&quot;</span> output-file-name</span>)</span>
    <span class="paren3">(<span class="default">call-with-output-file output-file-name write-function</span>)</span></span>)</span></span>)</span>

</pre></td></tr>
<tr id="section-33">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-33">&para;</a></div><h2>The "information" page</h2>
</td>
<td class="code">
<pre class="highlight">
</pre></td></tr>
<tr id="section-34">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-34">&para;</a></div><p>Write the HTML file. Function <code>call-with-output-file</code> will call the
<code>lambda</code> function passing as parameter a stream (the <code>file</code>
parameter) that can be used for writing. At the end of the
execution of the <code>lambda</code> function, the file will be automatically
closed (much like Python's <code>with</code> statement).</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default">write-html
 &#x27;information
 <span class="paren2">(<span class="default"><i><span class="symbol">lambda</span></i> <span class="paren3">(<span class="default">file</span>)</span>
   <span class="paren3">(<span class="default">display <span class="paren4">(<span class="default">wrap-html &#x27;information
		       <span class="string">&quot;General information about this release&quot;</span>
		       <span class="paren5">(<span class="default">&lt;p&gt; <span class="paren6">(<span class="default">format #f #&lt;&lt;EOF
This data release of <i><span class="symbol">the</span></i> null tests contains ~a
objects. It was generated on &lt;i&gt;~a&lt;/i&gt; by user &lt;b&gt;~a&lt;/b&gt;.
EOF
				    <span class="paren1">(<span class="default">length json-dictionary</span>)</span>
				    <span class="paren1">(<span class="default">date-&gt;string <span class="paren2">(<span class="default">current-date</span>)</span>
						  <span class="string">&quot;~A ~e ~B ~Y, at ~H:~M:~S&quot;</span></span>)</span>
				    <span class="paren1">(<span class="default">get-environment-variable <span class="string">&quot;USER&quot;</span></span>)</span></span>)</span></span>)</span></span>)</span>
	    file</span>)</span>
   <span class="paren3">(<span class="default">newline file</span>)</span></span>)</span></span>)</span>

</pre></td></tr>
<tr id="section-35">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-35">&para;</a></div><h2>The "Single survey coupled horn" page</h2>
</td>
<td class="code">
<pre class="highlight">
</pre></td></tr>
<tr id="section-36">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-36">&para;</a></div><p>Write the HTML file. The variable <code>cur-dict</code> contains a subset of
all the JSON entries stored in <code>json-dictionary</code> (loaded from the
JSON files specified from the command line).</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default">write-html
 &#x27;surv-pair
 <span class="paren2">(<span class="default"><i><span class="symbol">lambda</span></i> <span class="paren3">(<span class="default">file</span>)</span>
   <span class="paren3">(<span class="default"><i><span class="symbol">let*</span></i> <span class="paren4">(<span class="default"><span class="paren5">(<span class="default">cur-dict <span class="paren6">(<span class="default">filter-on-filetype <span class="string">&quot;single_survey_coupled_horn_map&quot;</span></span>)</span></span>)</span>
	  <span class="paren5">(<span class="default">fits-file-paths <span class="paren6">(<span class="default">map <span class="paren1">(<span class="default"><i><span class="symbol">lambda</span></i> <span class="paren2">(<span class="default">x</span>)</span>
				  <span class="paren2">(<span class="default">assq-ref &#x27;file_path x</span>)</span></span>)</span>
				cur-dict</span>)</span></span>)</span></span>)</span>
</span></span></span></span></span></span></pre></td></tr>
<tr id="section-37">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-37">&para;</a></div><p>Create the .gif files</p>
</td>
<td class="code">
<pre class="highlight">     <span class="paren1">(<span class="default">for-each <span class="paren2">(<span class="default"><i><span class="symbol">lambda</span></i> <span class="paren3">(<span class="default">test-result</span>)</span>
		 <span class="paren3">(<span class="default"><i><span class="symbol">let</span></i> <span class="paren4">(<span class="default"><span class="paren5">(<span class="default">fits-file-name <span class="paren6">(<span class="default">assq-ref &#x27;file_path test-result</span>)</span></span>)</span></span>)</span>
		   <span class="paren4">(<span class="default">format #t <span class="string">&quot;Writing to ~a</span><span class="string">\n</span><span class="string">&quot;</span> <span class="paren5">(<span class="default">fits-name-&gt;gif-name fits-file-name</span>)</span></span>)</span>
		   <span class="paren4">(<span class="default">map2gif fits-file-name
			    <span class="paren5">(<span class="default">filepath:join-path
			     <span class="paren6">(<span class="default">list <span class="paren1">(<span class="default">assq-ref &#x27;output-dir user-args</span>)</span>
				   <span class="paren1">(<span class="default">fits-name-&gt;gif-name fits-file-name</span>)</span></span>)</span></span>)</span>
			    <span class="paren5">(<span class="default">assq-ref &#x27;title test-result</span>)</span></span>)</span></span>)</span></span>)</span>
	       cur-dict</span>)</span>
     
</pre></td></tr>
<tr id="section-38">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-38">&para;</a></div><p>Write links to each image</p>
</td>
<td class="code">
<pre class="highlight">     <span class="paren1">(<span class="default">display <span class="paren2">(<span class="default">wrap-html &#x27;surv-pair
			 <span class="string">&quot;Coupled horn, survey differences&quot;</span>
			 <span class="paren3">(<span class="default">itemize <span class="paren4">(<span class="default">map <span class="paren5">(<span class="default"><i><span class="symbol">lambda</span></i> <span class="paren6">(<span class="default">fits-name</span>)</span>
					 <span class="paren6">(<span class="default"><i><span class="symbol">let</span></i> <span class="paren1">(<span class="default"><span class="paren2">(<span class="default">gif-name <span class="paren3">(<span class="default">fits-name-&gt;gif-name fits-name</span>)</span></span>)</span></span>)</span>
					   <span class="paren1">(<span class="default">&lt;img&gt; <span class="keyword">src:</span> gif-name
						  <span class="keyword">alt:</span> gif-name</span>)</span></span>)</span></span>)</span>
				       fits-file-paths</span>)</span></span>)</span></span>)</span>
	      file</span>)</span>
     <span class="paren1">(<span class="default">newline file</span>)</span>)))

</pre></td></tr>
<tr id="section-39">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-39">&para;</a></div><h2>The "Half rings" page</h2>
</td>
<td class="code">
<pre class="highlight">
</pre></td></tr>
<tr id="section-40">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-40">&para;</a></div><p>(write-html
 'halfring-frequency
 (lambda (file)
   (let* ((cur-dict (filter-on-filetype "halfring<em>frequency"))
      (fits-file-paths (map (lambda (x)
                  (assq-ref 'file</em>path x))
                cur-dict)))</p>
</td>
<td class="code">
<pre class="highlight">
</pre></td></tr>
<tr id="section-41">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-41">&para;</a></div><h1>Appendix: a very short introduction to Scheme</h1>

<p>To help the reader who has never read Scheme code, I am summarizing
here the main characteristics of the language. This is not a Scheme
tutorial, just a general introduction written for people that are
already proficient with some other language (in the text there are
many references to Python). If you are not interested in reading
the source code of this program, you can skip this section.</p>

<p>Chicken Scheme implements the
<a href="http://www.schemers.org/Documents/Standards/R5RS/">R5RS</a> standard
of Scheme, a language derived from LISP. Scheme is a really simple
language (the language and the standard library are described
together by a 50-page document: compare this with Python 2.7, which
needs 127 A4 pages for the language plus 1366 pages for the
standard library). This simplicity derives from three facts:</p>

<ol>
<li>The syntax is extremely simple: apart from letters and numbers,
the only symbols which have special meaning for the compiler are
<code>(</code>, <code>)</code>, quote, backtick, comma (rarely used) and whitespaces
(plus <code>;</code>, which starts a comment).</li>
<li>The standard library is quite small. Clearly this is not an
advantage, but Chicken Scheme provides a broad selection of
extensions, called "eggs", that mitigate this problem.</li>
<li>No complex features of high-end languages are specified by the
standard. For instance, a typical Python program uses OOP
techniques, which are grounded on many non-trivial concepts (object
encapsulation, inheritance, abstract methods, static methods...).
You can easily <a href="http://community.schemewiki.org/?object-systems">extend Scheme to support
OOP</a> through its
powerful macro system, but we won't do this in this program.</li>
</ol>

<p>Scheme is based on the concept of list, which is a series of
elements separated by spaces and enclosed within parentheses, like
<code>(1 2 3)</code>. Function calls are lists where the first element is the
function and the others are the parameters. E.g., to calculate the
sinus of 0.1 you write <code>(sin 0.2)</code>, to print a string you write
<code>(print "Hello, world!")</code>. By default, a list is always interpreted
as a function call, unless there is a <code>'</code> before the open
parenthesis. So <code>(sin 0.1)</code> calculates the sinus of 0.1, but <code>'(sin
0.1)</code> is a list of two elements: the first is the <code>sin</code> function,
the second is the number 0.1. Therefore, in Scheme program and data
share the same representation, and you can easily convert one into
another (using e.g. <code>eval</code>: <code>(eval '(sin 0.1))</code> is the same as
<code>(sin 0.1)</code>, but in the first case you can build your list
programatically).</p>

<p>The parenthesis syntax is used everywhere, also in mathematical
expressions ("infix notation", sometimes known as "reverse Polish
notation"). To calculate <code>5 * (1 + 2 + 3)</code> you write <code>(* 5 (+ 1 2
3))</code>. (Note that both <code>*</code> and <code>+</code> are used like any other function
call.)</p>

<p>Function and variable definition share the same syntax: you have to
use <code>define</code>. For instance, <code>(define x 1)</code> creates a new variable
which contains the integer 1, while <code>(define (f x) (* 2 x))</code>
defines a function <code>f</code> which accepts one parameter <code>x</code> and which
returns <code>x</code> doubled.</p>

<p>Similarly to Python, anonymous functions can be defined using
<code>lambda</code>. Unlike Python, Scheme's <code>lambda</code> expressions can contain
any sequence of instructions.</p>

<p>Loops can be implemented using either recursion (a "functional"
construct) or <code>do</code> (an "imperative" construct). However, for simple
programs like the one we are describing here, we only rely on
functions like <code>map</code> and <code>filter</code>, which are analogous to Python's
counterparts.</p>

<p>To end with an example, consider this quite idiomatic Python code:</p>

<pre><code>print ", ".join([x.upper() for x in ("a", "b", "c")])
</code></pre>

<p>which prints "A, B, C". It can be translated in Chicken Scheme:</p>

<pre><code>(string-intersperse (map string-upcase
                         '("a" "b" "c"))
                    ", ")
</code></pre>

<p>While Python uses many different syntactic elements (dot,
parentheses, brackets, the <code>for</code> and <code>in</code> keyword, explicit naming
of the <code>x</code> variable), everything in this Scheme snipped follows the
same idea of using parentheses to indicate both function calls and
lists.</p>

<p>(In Scheme you usually use much more newlines than in imperative
programs. This helps in visualizing which arguments are parts of
which list, as it is easy to get confused by nested parentheses. In
the following of this document, you can highlight parentheses on
the code on the right by moving the mouse over it.)</p>

<p>Scheme's syntax can look weird at first, but it is grounded on two
very simple elements: parentheses (which group elements) and white
spaces (which separate elements within parentheses). Compare this
with e.g. Python, where there are many symbols to be used in a
program: <code>()</code> identifies a tuple (or the parameters in a function
call), <code>[]</code> a list, <code>{}</code> a dictionary, <code>:</code> introduces a sub-loop or
a definition, <code>;</code> separates statements in the same line, etc. And
there are some strange quirks in the language, e.g. you have to
remember that a one-element list can be written as <code>[1]</code>, but for a
one-element tuple you must append a comma: <code>(1,)</code>.</p>

<h2>HTML generation and Scheme</h2>

<p>Thanks to its powerful macro system, Scheme (and LISP languages in
general) is very good in handling HTML, see e.g. Paul Graham's 16th
chapter of <a href="http://www.paulgraham.com/acl.html">ANSI Common LISP</a>.
The Chicken's library
<a href="http://wiki.call-cc.org/eggref/4/html-tags"><code>html-tags</code></a>
implements HTML-like commands in Scheme, which are converted into
strings. (A more sophisticated approach would use one of the many
Chicken's <a href="http://en.wikipedia.org/wiki/SXML">SXML</a> libraries.) The
idea is that every time you have some HTML tag in the form
<code>&lt;tag&gt;...&lt;/tag&gt;</code>, you write it as the Scheme command <code>(&lt;tag&gt; ...)</code>,
where parentheses are used to delimit the tag. This command is
converted into a string, that can then be printed on screen. Here
is an example:</p>

<pre><code>(require-extension html-tags)
(print (&lt;h1&gt; (format #f "The result of the sum is ~a" (+ 3 6))))
</code></pre>

<p>Note that we can call Scheme functions like <code>format</code> and <code>+</code> within
the HTML tags. This program will print</p>

<pre><code>&lt;h1&gt;The result of the sum is 9&lt;/h1&gt;
</code></pre>

<p>This differs substantially from the typical approach of using a
template library like Python's <a href="http://jinja.pocoo.org/docs">Jinja2
library</a> or
<a href="https://www.djangoproject.com">Django</a>: in that case, you write a
HTML template interspersed with Jinja2's <a href="http://jinja.pocoo.org/docs/templates/#expressions">internal
language</a>
(which, although similar, is <em>not</em> Python: see e.g. the use of the
<code>|</code> operator) - the same <a href="https://docs.djangoproject.com/en/1.4/topics/templates/">applies to Django as
well</a>.
Thus, you have to learn a new language (other than Python and HTML)
to use it. With Scheme, we're using it for everything!</p>
</td>
<td class="code">
<pre class="highlight"></pre></td></tr></table></div></body></html>