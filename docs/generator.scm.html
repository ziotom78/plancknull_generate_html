<!doctype html>
<html>
<head>
<title>generator.scm</title>
<link rel="stylesheet" href="schematic.css" /></head>
<body>
<div id="background"></div>
<div id="container">
<table cellspacing="0" cellpadding="0">
<tr>
<th class="docs">
<h1>generator.scm</h1></th>
<th class="code"></th></tr>
<tr id="section-1">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-1">&para;</a></div><h1>Null test HTML report generator</h1>

<p>Generate a HTML page containing the results of a set of null tests.</p>

<p>Author: Maurizio Tomasi</p>

<p>Start date: August 13th, 2012</p>
</td>
<td class="code">
<pre class="highlight">
</pre></td></tr>
<tr id="section-2">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-2">&para;</a></div><h1>Initialization</h1>
</td>
<td class="code">
<pre class="highlight">
</pre></td></tr>
<tr id="section-3">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-3">&para;</a></div><p>We need the <code>json</code> egg in order to load the database of null test
results written by the Python script. The <code>html-tags</code> and
<code>html-utils</code> eggs are very useful to generate HTML from code, much
in the same way as described in Paul Graham's 16th chapter of <a href="http://www.paulgraham.com/acl.html">ANSI
Common LISP</a>. The <code>shell</code> egg
is used to call <code>map2gif</code>. The eggs <code>filepath</code> and
<code>directory-utils</code> are used respectively to manipulate file paths
and to create/modify the directory structure of a file system (we
are going to use it to create the tree of directories that will
contain the HTML report). SRFI-19 implements a set of functions to
deal with date and times. We use it to put timestamps in the
report.</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default">require-extension json</span>)</span>
<span class="paren1">(<span class="default">require-extension html-tags</span>)</span>
<span class="paren1">(<span class="default">require-extension html-utils</span>)</span>
<span class="paren1">(<span class="default">require-extension shell</span>)</span>
<span class="paren1">(<span class="default">require-extension filepath</span>)</span>
<span class="paren1">(<span class="default">require-extension directory-utils</span>)</span>
<span class="paren1">(<span class="default">require-extension srfi-19</span>)</span>

<span class="paren1">(<span class="default">include <span class="string">&quot;json-utils.scm&quot;</span></span>)</span> <span class="paren1">(<span class="default">import json-utils</span>)</span>
<span class="paren1">(<span class="default">include <span class="string">&quot;file-utils.scm&quot;</span></span>)</span> <span class="paren1">(<span class="default">import file-utils</span>)</span>

</pre></td></tr>
<tr id="section-4">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-4">&para;</a></div><p>We're going to concatenate a number of HTML statements, so it is
nicer to have a shorthand for the Scheme function
<code>string-concatenate</code>. Note that Scheme identifiers can include
symbols as well, not only letters and numbers.</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> html:++ string-concatenate</span>)</span>

</pre></td></tr>
<tr id="section-5">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-5">&para;</a></div><h1>Command-line parsing</h1>
</td>
<td class="code">
<pre class="highlight">
</pre></td></tr>
<tr id="section-6">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-6">&para;</a></div><p>Here we implement the code that will read the JSON files from the
command-line and merge them into one big list of dictionaries
(a-lists).</p>
</td>
<td class="code">
<pre class="highlight">
</pre></td></tr>
<tr id="section-7">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-7">&para;</a></div><p>If <code>args</code> is the list of command-line arguments provided to the
program, function <code>parse-command-line</code> analyzes them and returns an
associative list containing the following fields: <code>'output-dir</code> is
a string specifying the directory where to save the report,
<code>'input-dir</code> is a string containing the path where to look for JSON
files.</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> <span class="paren2">(<span class="default">parse-command-line program-name args</span>)</span>
  <span class="paren2">(<span class="default"><i><span class="symbol">if</span></i> <span class="paren3">(<span class="default">not <span class="paren4">(<span class="default">eq? <span class="paren5">(<span class="default">length args</span>)</span> 2</span>)</span></span>)</span>
      <span class="paren3">(<span class="default">begin <span class="paren4">(<span class="default">format #t #&lt;&lt;EOF
<span class="keyword">Usage:</span> ~a NULL_TEST_DIR OUTPUT_PATH

where NULL_TEST_DIR is <i><span class="symbol">the</span></i> path to <i><span class="symbol">the</span></i> directory containing
<i><span class="symbol">the</span></i> results of <i><span class="symbol">the</span></i> null tests to be included in <i><span class="symbol">the</span></i> report,
and OUTPUT_PATH is <i><span class="symbol">the</span></i> path where to save <i><span class="symbol">the</span></i> files of <i><span class="symbol">the</span></i>
HTML report. If OUTPUT_PATH does not exist, it will be created.

EOF
                     program-name</span>)</span>
             <span class="paren4">(<span class="default">exit 1</span>)</span></span>)</span></span>)</span>
  <span class="paren2">(<span class="default">list <span class="paren3">(<span class="default">cons &#x27;input-dir <span class="paren4">(<span class="default">car args</span>)</span></span>)</span>
        <span class="paren3">(<span class="default">cons &#x27;output-dir <span class="paren4">(<span class="default">cadr args</span>)</span></span>)</span></span>)</span></span>)</span>

</pre></td></tr>
<tr id="section-8">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-8">&para;</a></div><p>The variable <code>user-args</code> holds all the information the user
specified from the command line. Note that <code>argv</code> (function, not
variable!) is not part of R5RS: it is a Chicken extension.</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> user-args <span class="paren2">(<span class="default">parse-command-line <span class="paren3">(<span class="default">car <span class="paren4">(<span class="default">argv</span>)</span></span>)</span>
                                      <span class="paren3">(<span class="default">cdr <span class="paren4">(<span class="default">argv</span>)</span></span>)</span></span>)</span></span>)</span>

<span class="paren1">(<span class="default">format #t <span class="string">&quot;Report will be created under the following path: ~a</span><span class="string">\n</span><span class="string">&quot;</span>
        <span class="paren2">(<span class="default">assq-ref &#x27;output-dir user-args</span>)</span></span>)</span>
<span class="paren1">(<span class="default">format #t <span class="string">&quot;Directory where to look for JSON files: ~a</span><span class="string">\n</span><span class="string">&quot;</span>
        <span class="paren2">(<span class="default">assq-ref &#x27;input-dir user-args</span>)</span></span>)</span>

</pre></td></tr>
<tr id="section-9">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-9">&para;</a></div><p>Find all the files in the null test directory and read their
contents, then assemble all the objects (a-lists) into a list
(using <code>extract-alists-from-json-file</code>). Note that <code>append</code> is not
a R5RS built-in (it is part of
<a href="http://srfi.schemers.org/srfi-1/srfi-1.html">SRFI-1</a>), but Chicken
incorporates it. Also, <code>find-files</code> is part of the Chicken <code>posix</code>
library, and it accepts regular expressions to match the files (the
meaning of <code>.+\\.json$</code> is: a sequence of N>0 characters which ends
with <code>.json</code>).</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> json-dictionary
  <span class="paren2">(<span class="default">apply append <span class="paren3">(<span class="default">map extract-alists-from-json-file
                     <span class="paren4">(<span class="default">find-files <span class="paren5">(<span class="default">assq-ref &#x27;input-dir user-args</span>)</span>
                                 <span class="string">&quot;.+</span><span class="string">\\</span><span class="string">.json$&quot;</span></span>)</span></span>)</span></span>)</span></span>)</span>

</pre></td></tr>
<tr id="section-10">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-10">&para;</a></div><p>The function <code>filter-on-filetype</code> filters the contents of
<code>json-dictionary</code> acc ording to a given file type. The use of
<code>filter</code> is exactly the same as in Python.</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> <span class="paren2">(<span class="default">filter-on-filetype file-type</span>)</span>
  <span class="paren2">(<span class="default">filter <span class="paren3">(<span class="default"><i><span class="symbol">lambda</span></i> <span class="paren4">(<span class="default">object</span>)</span>
            <span class="paren4">(<span class="default">equal? <span class="paren5">(<span class="default">assq-ref &#x27;file_type object</span>)</span>
                    file-type</span>)</span></span>)</span>
          json-dictionary</span>)</span></span>)</span>

</pre></td></tr>
<tr id="section-11">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-11">&para;</a></div><p>Given a JSON object, returns the full path associated with it. To
understand this code, keep in mind that the path specified in each
JSON object is relative to the root directory where the null tests
were saved. The path to this root directory is passed to the
program through the command line (hence the reference to
<code>user-args</code>).</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> <span class="paren2">(<span class="default">abspath-from-json object</span>)</span>
  <span class="paren2">(<span class="default">filepath:join-path
   <span class="paren3">(<span class="default">list
    <span class="paren4">(<span class="default">assq-ref &#x27;input-dir user-args</span>)</span>
    <span class="paren4">(<span class="default">assq-ref &#x27;file_name object</span>)</span></span>)</span></span>)</span></span>)</span>

</pre></td></tr>
<tr id="section-12">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-12">&para;</a></div><h1>Report generation</h1>
</td>
<td class="code">
<pre class="highlight">
</pre></td></tr>
<tr id="section-13">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-13">&para;</a></div><p>We copy the content of a number of directories into the destination
path using <code>dir-copy</code> (defined in <code>file-utils.scm</code>). Currently only
<code>css</code> is copied, but a separate directory <code>js</code> for JavaScript files
might be needed in the future).</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default"><i><span class="symbol">let</span></i> <span class="paren2">(<span class="default"><span class="paren3">(<span class="default">source-dir <span class="paren4">(<span class="default">filepath:take-directory <span class="paren5">(<span class="default">car <span class="paren6">(<span class="default">argv</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>
  <span class="paren2">(<span class="default">for-each
   <span class="paren3">(<span class="default"><i><span class="symbol">lambda</span></i> <span class="paren4">(<span class="default">dir-name</span>)</span>
     <span class="paren4">(<span class="default">dir-copy <span class="paren5">(<span class="default">filepath:join-path <span class="paren6">(<span class="default">list source-dir dir-name</span>)</span></span>)</span>
               <span class="paren5">(<span class="default">filepath:join-path <span class="paren6">(<span class="default">list <span class="paren1">(<span class="default">assq-ref &#x27;output-dir user-args</span>)</span>
                                         dir-name</span>)</span></span>)</span></span>)</span></span>)</span>
   <span class="paren3">(<span class="default">list <span class="string">&quot;css&quot;</span></span>)</span></span>)</span></span>)</span>

</pre></td></tr>
<tr id="section-14">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-14">&para;</a></div><h2>General-purpose functions</h2>
</td>
<td class="code">
<pre class="highlight">
</pre></td></tr>
<tr id="section-15">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-15">&para;</a></div><p>We keep the names of the HTML files to be created in a alist for
avoiding repetitions in the code (they must be used when creating
the files and when producing the <code>&lt;a&gt;</code> links in the side menu). The
function <code>get-html-file-name</code> is the only access function we need
for this alist, so we make <code>html-file-name</code> a local definition.</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> <span class="paren2">(<span class="default">get-html-file-name label</span>)</span>
  <span class="paren2">(<span class="default"><i><span class="symbol">let</span></i> <span class="paren3">(<span class="default"><span class="paren4">(<span class="default">html-file-names
         &#x27;<span class="paren5">(<span class="default"><span class="paren6">(<span class="default">information . <span class="string">&quot;index.html&quot;</span></span>)</span>
	   <span class="paren6">(<span class="default">halfring-pair . <span class="string">&quot;halfring_pair.html&quot;</span></span>)</span>
           <span class="paren6">(<span class="default">halfring-frequency . <span class="string">&quot;halfring_freq.html&quot;</span></span>)</span>
           <span class="paren6">(<span class="default">surv-rad . <span class="string">&quot;surv_radiometer.html&quot;</span></span>)</span>
           <span class="paren6">(<span class="default">surv-horn . <span class="string">&quot;surv_horn.html&quot;</span></span>)</span>
           <span class="paren6">(<span class="default">surv-pair . <span class="string">&quot;surv_pair.html&quot;</span></span>)</span>
           <span class="paren6">(<span class="default">surv-frequency . <span class="string">&quot;surv_freq.html&quot;</span></span>)</span>
           <span class="paren6">(<span class="default">surv-cross-freq . <span class="string">&quot;surv_cross.html&quot;</span></span>)</span>
           <span class="paren6">(<span class="default">full-pair . <span class="string">&quot;full_pair.html&quot;</span></span>)</span>
           <span class="paren6">(<span class="default">full-frequency . <span class="string">&quot;full_freq.html&quot;</span></span>)</span>
           <span class="paren6">(<span class="default">full-cross-freq . <span class="string">&quot;full_cross.html&quot;</span></span>)</span>
           <span class="paren6">(<span class="default">table-of-contents . <span class="string">&quot;toc.html&quot;</span></span>)</span></span>)</span></span>)</span></span>)</span>
    <span class="paren3">(<span class="default">assq-ref label html-file-names</span>)</span></span>)</span></span>)</span>

</pre></td></tr>
<tr id="section-16">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-16">&para;</a></div><p>Each HTML page contains a menu on the left, whose look is specified
by the CSS file <code>css/menu.css</code>. Function <code>side-menu</code> is
responsibile for creating this menu for each HTML page. The
argument <code>page-tag</code> is one of the symbols recognized by
<code>get-html-file-name</code> (see above), and specifies for which HTML page
we are generating this menu. We define a <code>smart-&lt;a&gt;</code> function which
uses <code>get-html-file-name</code> to retrieve the link to be used in the
<code>&lt;a&gt;</code> tag, and it also defines the class according to the fact that
the entry links to its own page or not (the CSS style uses this to
highlight selected items in bold).</p>

<p>Note how nice is to use the <code>html-tag</code> package: we are producing
HTML code using commands like <code>&lt;a&gt;</code> just in plain HTML, yet we can
freely call Scheme functions within it (in this case,
<code>get-html-file-name</code>).</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> <span class="paren2">(<span class="default">side-menu page-tag</span>)</span>
  <span class="paren2">(<span class="default"><i><span class="symbol">let</span></i> <span class="paren3">(<span class="default"><span class="paren4">(<span class="default">smart-&lt;a&gt; <span class="paren5">(<span class="default"><i><span class="symbol">lambda</span></i> <span class="paren6">(<span class="default">title tag</span>)</span>
                     <span class="paren6">(<span class="default">&lt;a&gt; <span class="keyword">href:</span> <span class="paren1">(<span class="default">get-html-file-name tag</span>)</span>
                          <span class="keyword">class:</span> <span class="paren1">(<span class="default"><i><span class="symbol">if</span></i> <span class="paren2">(<span class="default">eq? tag page-tag</span>)</span>
                                     <span class="string">&quot;selected&quot;</span>
                                     <span class="string">&quot;unselected&quot;</span></span>)</span>
                          title</span>)</span></span>)</span></span>)</span></span>)</span>
    <span class="paren3">(<span class="default">&lt;nav&gt; <span class="keyword">id:</span> <span class="string">&quot;nav&quot;</span>
           <span class="paren4">(<span class="default">&lt;ul&gt; <span class="keyword">id:</span> <span class="string">&quot;menu&quot;</span>
                 <span class="paren5">(<span class="default">&lt;li&gt; <span class="paren6">(<span class="default">smart-&lt;a&gt; <span class="string">&quot;Information&quot;</span> &#x27;information</span>)</span></span>)</span>
                 <span class="paren5">(<span class="default">&lt;li&gt; <span class="string">&quot;1-h tests (half rings) &amp;raquo;&quot;</span>
                       <span class="paren6">(<span class="default">&lt;ul&gt; <span class="paren1">(<span class="default">smart-&lt;a&gt; <span class="string">&quot;Horn pair&quot;</span> &#x27;halfring-pair</span>)</span></span>)</span>
                       <span class="paren6">(<span class="default">&lt;ul&gt; <span class="paren1">(<span class="default">smart-&lt;a&gt; <span class="string">&quot;Frequency&quot;</span> &#x27;halfring-frequency</span>)</span></span>)</span></span>)</span>
                 <span class="paren5">(<span class="default">&lt;li&gt; <span class="string">&quot;Survey tests &amp;raquo;&quot;</span>
                       <span class="paren6">(<span class="default">&lt;ul&gt;
                        <span class="paren1">(<span class="default">&lt;li&gt; <span class="paren2">(<span class="default">smart-&lt;a&gt; <span class="string">&quot;Single radiometer&quot;</span> &#x27;surv-rad</span>)</span></span>)</span>
                        <span class="paren1">(<span class="default">&lt;li&gt; <span class="paren2">(<span class="default">smart-&lt;a&gt; <span class="string">&quot;Single horn&quot;</span> &#x27;surv-horn</span>)</span></span>)</span>
                        <span class="paren1">(<span class="default">&lt;li&gt; <span class="paren2">(<span class="default">smart-&lt;a&gt; <span class="string">&quot;Horn pair&quot;</span> &#x27;surv-pair</span>)</span></span>)</span>
                        <span class="paren1">(<span class="default">&lt;li&gt; <span class="paren2">(<span class="default">smart-&lt;a&gt; <span class="string">&quot;Frequency&quot;</span> &#x27;surv-frequency</span>)</span></span>)</span>
                        <span class="paren1">(<span class="default">&lt;li&gt; <span class="paren2">(<span class="default">smart-&lt;a&gt; <span class="string">&quot;Cross-frequency&quot;</span> &#x27;surv-cross-freq</span>)</span></span>)</span></span>)</span></span>)</span>
                 <span class="paren5">(<span class="default">&lt;li&gt; <span class="string">&quot;Full-mission tests &amp;raquo;&quot;</span>
                       <span class="paren6">(<span class="default">&lt;ul&gt;
                        <span class="paren1">(<span class="default">&lt;li&gt; <span class="paren2">(<span class="default">smart-&lt;a&gt; <span class="string">&quot;Horn pair&quot;</span> &#x27;full-pair</span>)</span></span>)</span>
                        <span class="paren1">(<span class="default">&lt;li&gt; <span class="paren2">(<span class="default">smart-&lt;a&gt; <span class="string">&quot;Frequency&quot;</span> &#x27;full-frequency</span>)</span></span>)</span>
                        <span class="paren1">(<span class="default">&lt;li&gt; <span class="paren2">(<span class="default">smart-&lt;a&gt; <span class="string">&quot;Cross-frequency&quot;</span> &#x27;full-cross-freq</span>)</span></span>)</span></span>)</span></span>)</span>
                 <span class="paren5">(<span class="default">&lt;li&gt; <span class="paren6">(<span class="default">smart-&lt;a&gt; <span class="string">&quot;Table of contents&quot;</span> &#x27;table-of-contents</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>

</pre></td></tr>
<tr id="section-17">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-17">&para;</a></div><p>This is the name of the data release. <em>TODO</em>: make the release name
specifiable from the command line/configuration file</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> test-release-name <span class="string">&quot;DX9&quot;</span></span>)</span>

</pre></td></tr>
<tr id="section-18">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-18">&para;</a></div><p>The function <code>make-title-for-report</code> makes up the title for the
overall report, which is going to be repeated at the beginning of
each HTML page. It does so by prepending the name of the data
release to the title itself (in the parameter <code>string</code>). We want to
put the name of the release (e.g. <code>DX9</code>) at the beginning, so it
will be shown by tabbed browsers like Chrome even when a lot of
tabs are opened.</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> <span class="paren2">(<span class="default">make-title-for-report</span>)</span>
  <span class="paren2">(<span class="default">format #f <span class="string">&quot;~a null tests&quot;</span> test-release-name</span>)</span></span>)</span>

</pre></td></tr>
<tr id="section-19">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-19">&para;</a></div><p>The function <code>wrap-html</code> takes a string containing some HTML code
and encloses it in a self-contained HTML structure which comprises
the side menu. It returns a string.</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> <span class="paren2">(<span class="default">wrap-html file-tag page-title body</span>)</span>
  <span class="paren2">(<span class="default">html-page <span class="paren3">(<span class="default">html:++ <span class="paren4">(<span class="default">list
                       <span class="paren5">(<span class="default">&lt;h1&gt; <span class="paren6">(<span class="default">make-title-for-report</span>)</span></span>)</span>
                       <span class="paren5">(<span class="default">side-menu file-tag</span>)</span>
                       <span class="paren5">(<span class="default">&lt;div&gt; <span class="keyword">id:</span> <span class="string">&quot;body&quot;</span>
                              <span class="paren6">(<span class="default">&lt;h2&gt; page-title</span>)</span>
                              body</span>)</span></span>)</span></span>)</span>
             <span class="keyword">title:</span> page-title
             <span class="keyword">css:</span> &#x27;<span class="paren3">(<span class="default"><span class="string">&quot;css/main.css&quot;</span> <span class="string">&quot;css/menu.css&quot;</span></span>)</span></span>)</span></span>)</span>

</pre></td></tr>
<tr id="section-20">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-20">&para;</a></div><p>We are going to create a number of HTML files, and the creation of
each of them follows the same rules:</p>

<ol>
<li>Determine the name of the file using <code>get-html-file-name</code></li>
<li>Ensure that the directory where this file will be written exists</li>
<li>Inform the user about the pathname of the file we are going to
write</li>
<li>Write the file.</li>
</ol>

<p>Function <code>write-html</code> wraps all of this into one function. The
parameter <code>file-tag</code> is passed to <code>get-html-file-name</code> as it is,
while <code>write-function</code> is a function accepting as its unique
parameter the output stream to be used to write into the file.</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> <span class="paren2">(<span class="default">write-html file-tag write-function</span>)</span>
  <span class="paren2">(<span class="default"><i><span class="symbol">let</span></i> <span class="paren3">(<span class="default"><span class="paren4">(<span class="default">output-file-name <span class="paren5">(<span class="default">filepath:join-path
                           <span class="paren6">(<span class="default">list <span class="paren1">(<span class="default">assq-ref &#x27;output-dir user-args</span>)</span>
                                 <span class="paren1">(<span class="default">get-html-file-name file-tag</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>
    <span class="paren3">(<span class="default">create-pathname-directory output-file-name</span>)</span>
    <span class="paren3">(<span class="default">format #t <span class="string">&quot;Writing file ~a...</span><span class="string">\n</span><span class="string">&quot;</span> output-file-name</span>)</span>
    <span class="paren3">(<span class="default">call-with-output-file output-file-name write-function</span>)</span></span>)</span></span>)</span>

</pre></td></tr>
<tr id="section-21">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-21">&para;</a></div><h2>The "information" page</h2>
</td>
<td class="code">
<pre class="highlight">
</pre></td></tr>
<tr id="section-22">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-22">&para;</a></div><p>Write the HTML file. Function <code>call-with-output-file</code> will call the
<code>lambda</code> function passing as parameter a stream (the <code>file</code>
parameter) that can be used for writing. At the end of the
execution of the <code>lambda</code> function, the file will be automatically
closed (much like Python's <code>with</code> statement).</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default">write-html
 &#x27;information
 <span class="paren2">(<span class="default"><i><span class="symbol">lambda</span></i> <span class="paren3">(<span class="default">file</span>)</span>
   <span class="paren3">(<span class="default">display <span class="paren4">(<span class="default">wrap-html &#x27;information
                       <span class="string">&quot;General information about this release&quot;</span>
                       <span class="paren5">(<span class="default">&lt;p&gt; <span class="paren6">(<span class="default">format #f #&lt;&lt;EOF
This data release of <i><span class="symbol">the</span></i> null tests contains ~a
objects. It was generated on &lt;i&gt;~a&lt;/i&gt; by user &lt;b&gt;~a&lt;/b&gt;.

EOF
                                    <span class="paren1">(<span class="default">length json-dictionary</span>)</span>
                                    <span class="paren1">(<span class="default">date-&gt;string <span class="paren2">(<span class="default">current-date</span>)</span>
                                                  <span class="string">&quot;~A ~e ~B ~Y, at ~H:~M:~S&quot;</span></span>)</span>
                                    <span class="paren1">(<span class="default">get-environment-variable <span class="string">&quot;USER&quot;</span></span>)</span></span>)</span></span>)</span></span>)</span>
            file</span>)</span>
   <span class="paren3">(<span class="default">newline file</span>)</span></span>)</span></span>)</span>

</pre></td></tr>
<tr id="section-23">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-23">&para;</a></div><h2>The "Single survey coupled horn" page</h2>
</td>
<td class="code">
<pre class="highlight">
</pre></td></tr>
<tr id="section-24">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-24">&para;</a></div><p>Write the HTML file. The variable <code>cur-dict</code> contains a subset of
all the JSON entries stored in <code>json-dictionary</code> (loaded from the
JSON files specified from the command line).</p>
</td>
<td class="code">
<pre class="highlight"><span class="paren1">(<span class="default">write-html
 &#x27;surv-pair
 <span class="paren2">(<span class="default"><i><span class="symbol">lambda</span></i> <span class="paren3">(<span class="default">file</span>)</span>
   <span class="paren3">(<span class="default"><i><span class="symbol">let</span></i> <span class="paren4">(<span class="default"><span class="paren5">(<span class="default">list-of-objs <span class="paren6">(<span class="default">sort <span class="paren1">(<span class="default">filter-on-filetype <span class="string">&quot;surveydiff_detset_map&quot;</span></span>)</span>
			     <span class="paren1">(<span class="default"><i><span class="symbol">lambda</span></i> <span class="paren2">(<span class="default">x y</span>)</span>
</span></span></span></span></span></span></span></span></span></span></span></span></span></span></pre></td></tr>
<tr id="section-25">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-25">&para;</a></div><p>Sort the entries according to their channel</p>
</td>
<td class="code">
<pre class="highlight">			       <span class="paren1">(<span class="default">string&lt;? <span class="paren2">(<span class="default">assq-ref &#x27;channel x</span>)</span>
					 <span class="paren2">(<span class="default">assq-ref &#x27;channel y</span>)</span></span>)</span>)))

</pre></td></tr>
<tr id="section-26">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-26">&para;</a></div><p>The function <code>emit-HTML-index-entry-for-object is still
part of the</code>let` above. It accepts a JSON object and will
produce a link to the entry.</p>
</td>
<td class="code">
<pre class="highlight">	 <span class="paren1">(<span class="default">emit-HTML-index-entry-for-object
	  <span class="paren2">(<span class="default"><i><span class="symbol">lambda</span></i> <span class="paren3">(<span class="default">obj</span>)</span>
	    <span class="paren3">(<span class="default"><i><span class="symbol">let</span></i> <span class="paren4">(<span class="default"><span class="paren5">(<span class="default">title <span class="paren6">(<span class="default">assq-ref &#x27;title obj</span>)</span></span>)</span></span>)</span>
	      <span class="paren4">(<span class="default">&lt;ul&gt; <span class="paren5">(<span class="default">&lt;a&gt; <span class="keyword">href:</span> <span class="string">&quot;#&quot;</span> title <span class="string">&quot;</span><span class="string">\n</span><span class="string">&quot;</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>

</pre></td></tr>
<tr id="section-27">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-27">&para;</a></div><p>The function <code>emit-HTML-for-object</code> is still part of the
<code>let</code> above. It accepts a JSON object and will produce
HTML code to be put straight into the page.</p>
</td>
<td class="code">
<pre class="highlight">	 <span class="paren1">(<span class="default">emit-HTML-for-object
	  <span class="paren2">(<span class="default"><i><span class="symbol">lambda</span></i> <span class="paren3">(<span class="default">obj</span>)</span>
	    <span class="paren3">(<span class="default"><i><span class="symbol">let*</span></i> <span class="paren4">(<span class="default"><span class="paren5">(<span class="default">title <span class="paren6">(<span class="default">assq-ref &#x27;title obj</span>)</span></span>)</span>
		   <span class="paren5">(<span class="default">fits-file-name <span class="paren6">(<span class="default">abspath-from-json obj</span>)</span></span>)</span>
		   <span class="paren5">(<span class="default">gif-file-name <span class="paren6">(<span class="default">fits-name-&gt;gif-name fits-file-name</span>)</span></span>)</span></span>)</span>
	      <span class="paren4">(<span class="default">format #t <span class="string">&quot;Writing GIF file ~a</span><span class="string">\n</span><span class="string">&quot;</span> gif-file-name</span>)</span>
	      <span class="paren4">(<span class="default">map2gif fits-file-name
		       <span class="paren5">(<span class="default">filepath:join-path
			<span class="paren6">(<span class="default">list <span class="paren1">(<span class="default">assq-ref &#x27;output-dir user-args</span>)</span>
			      gif-file-name</span>)</span></span>)</span>
		       title</span>)</span>
	      <span class="paren4">(<span class="default">&lt;div&gt; <span class="keyword">class:</span> <span class="string">&quot;page_section&quot;</span>
	       <span class="paren5">(<span class="default">&lt;h4&gt; title</span>)</span>
	       <span class="string">&quot;</span><span class="string">\n</span><span class="string">&quot;</span>
	       <span class="paren5">(<span class="default">&lt;img&gt; <span class="keyword">src:</span> gif-file-name <span class="keyword">alt:</span> title</span>)</span>
	       <span class="string">&quot;</span><span class="string">\n</span><span class="string">&quot;</span></span>)</span></span>)</span></span>)</span></span>)</span>)

</pre></td></tr>
<tr id="section-28">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-28">&para;</a></div><p>The <code>let</code> has ended, now comes the body of <code>lambda (file)
...</code>. We simply apply <code>emit-HTML-for-object</code> to the whole list
of objects, and wrap the output into some nice HTML tags
(using <code>wrap-html</code>).</p>
</td>
<td class="code">
<pre class="highlight">     <span class="paren1">(<span class="default">display <span class="paren2">(<span class="default">wrap-html &#x27;surv-pair
                         <span class="string">&quot;Coupled horn, survey differences&quot;</span>
			 <span class="paren3">(<span class="default">html:++ <span class="paren4">(<span class="default">list <span class="paren5">(<span class="default">&lt;div&gt; <span class="keyword">class:</span> <span class="string">&quot;page_index&quot;</span>
					       <span class="paren6">(<span class="default">itemize <span class="paren1">(<span class="default">map emit-HTML-index-entry-for-object
							  list-of-objs</span>)</span></span>)</span></span>)</span>
					<span class="paren5">(<span class="default">string-intersperse
					 <span class="paren6">(<span class="default">map emit-HTML-for-object list-of-objs</span>)</span>
					 <span class="string">&quot;</span><span class="string">\n</span><span class="string">&quot;</span></span>)</span></span>)</span></span>)</span></span>)</span>
	      file</span>)</span>
     <span class="paren1">(<span class="default">newline file</span>)</span>)))

</pre></td></tr>
<tr id="section-29">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-29">&para;</a></div><h2>The "Half rings" page</h2>
</td>
<td class="code">
<pre class="highlight">
</pre></td></tr>
<tr id="section-30">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-30">&para;</a></div><p>(write-html
 'halfring-frequency
 (lambda (file)
   (let* ((cur-dict (filter-on-filetype "halfring<em>frequency"))
       (fits-file-paths (map (lambda (x)
                               (assq-ref 'file</em>name x))
                             cur-dict)))</p>
</td>
<td class="code">
<pre class="highlight"></pre></td></tr></table></div></body></html>