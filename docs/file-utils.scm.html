<!doctype html>
<html>
<head>
<title>file-utils.scm</title>
<link rel="stylesheet" href="schematic.css" /></head>
<body>
<div id="background"></div>
<div id="container">
<table cellspacing="0" cellpadding="0">
<tr>
<th class="docs">
<h1>file-utils.scm</h1></th>
<th class="code"></th></tr>
<tr id="section-1">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-1">&para;</a></div><h1>File utilities</h1>
</td>
<td class="code">
<pre class="highlight">
</pre></td></tr>
<tr id="section-2">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-2">&para;</a></div><p>This module contains a number of general-purpose functions that
help dealing with the (usually large) amount of files handled by
the program.</p>
</td>
<td class="code">
<pre class="highlight">
<span class="paren1">(<span class="default">module file-utils
  <span class="paren2">(<span class="default">map-&gt;gif
   spectrum-&gt;gif
   fits-name-&gt;gif-name
   dir-copy</span>)</span>

  <span class="paren2">(<span class="default">import chicken
	  scheme
	  extras
	  files
	  data-structures
	  posix
	  healpix
	  srfi-1
	  srfi-4
	  srfi-13</span>)</span>
  <span class="paren2">(<span class="default">require-extension shell</span>)</span>
  <span class="paren2">(<span class="default">require-extension filepath</span>)</span>
  <span class="paren2">(<span class="default">require-extension directory-utils</span>)</span>

</span></span></pre></td></tr>
<tr id="section-3">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-3">&para;</a></div><p>We need to implement the code that will convert the maps in FITS
format into GIF images that can be included in the HTML report. We
assume the availability of the <code>map2tga</code> program bundled with
<a href="http://healpix.jpl.nasa.gov/">Healpix</a>.</p>
</td>
<td class="code">
<pre class="highlight">
</pre></td></tr>
<tr id="section-4">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-4">&para;</a></div><p>First we define a simple function that uses <code>map2tga</code> and
ImageMagick's <code>convert</code> to produce a GIF file with the map
(<code>map2gif</code> has a
<a href="http://sourceforge.net/tracker/?func=detail&amp;aid=3559308&amp;group_id=130539&amp;atid=718128">bug</a>
that prevents it from creating valid GIF images, at least in
Healpix 2.20a).</p>
</td>
<td class="code">
<pre class="highlight">  <span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> <span class="paren2">(<span class="default">create-1-gif input-fits-file-name
			output-gif-file-name
			title
			width
			component-number</span>)</span>
</span></span></pre></td></tr>
<tr id="section-5">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-5">&para;</a></div><p>Run <code>map2tga</code> and <code>convert</code>. Note the elegance of "run<em>"
(from the "shell" egg): we include the command-line switches
as if they were Scheme symbols! (We put a comma in front of
<code>(html:++ ...)</code> because we want it to be interpreted as a
Scheme expression: otherwise it would be put as it is in the
arguments to the process call.) *Note:</em> <code>run*</code> is defined in
the <code>shell</code> egg. When multiple commands are specified (in
this case, <code>map2tga</code> and <code>convert</code>), it returns a set of
values. These must be interpreted using <code>call-with-values</code>,
which is a standard Scheme function accepting a "producer"
and a "consumer". Refer to the <a href="http://wiki.call-cc.org/man/4/The%20R5RS%20standard#control-features">R5RS
documentation</a>
for further details.</p>
</td>
<td class="code">
<pre class="highlight">    <span class="paren1">(<span class="default"><i><span class="symbol">let</span></i> <span class="paren2">(<span class="default"><span class="paren3">(<span class="default">output-tga-file-name
	   <span class="paren4">(<span class="default">filepath:replace-extension output-gif-file-name <span class="string">&quot;.tga&quot;</span></span>)</span></span>)</span></span>)</span>
      <span class="paren2">(<span class="default">call-with-values
	  <span class="paren3">(<span class="default"><i><span class="symbol">lambda</span></i> <span class="paren4">(<span class="default"></span>)</span>
	    <span class="paren4">(<span class="default">format #t <span class="string">&quot;Running map2tga and convert on ~a...</span><span class="string">\n</span><span class="string">&quot;</span>
		    input-fits-file-name</span>)</span>
	    <span class="paren4">(<span class="default">run* <span class="paren5">(<span class="default">map2tga ,input-fits-file-name
			   ,output-tga-file-name
			   -bar
			   -xsz ,width
			   -sig ,component-number
			   -title ,<span class="paren6">(<span class="default">string-concatenate <span class="paren1">(<span class="default">list <span class="string">&quot;</span><span class="string">\&quot;</span><span class="string">&quot;</span> title <span class="string">&quot;</span><span class="string">\&quot;</span><span class="string">&quot;</span></span>)</span></span>)</span></span>)</span>
		  <span class="paren5">(<span class="default">convert ,output-tga-file-name
			   -transparent white
			   ,output-gif-file-name</span>)</span></span>)</span></span>)</span>
	<span class="paren3">(<span class="default"><i><span class="symbol">lambda</span></i> <span class="paren4">(<span class="default">map2tga-return-code convert-return-code</span>)</span>
	  <span class="paren4">(<span class="default"><i><span class="symbol">if</span></i> <span class="paren5">(<span class="default">&gt; map2tga-return-code 0</span>)</span>
	      <span class="paren5">(<span class="default">abort <span class="string">&quot;Error when executing </span><span class="string">\&quot;</span><span class="string">map2tga</span><span class="string">\&quot;</span><span class="string">&quot;</span></span>)</span></span>)</span>
	  <span class="paren4">(<span class="default"><i><span class="symbol">if</span></i> <span class="paren5">(<span class="default">&gt; convert-return-code 0</span>)</span>
	      <span class="paren5">(<span class="default">abort <span class="string">&quot;Error when executing </span><span class="string">\&quot;</span><span class="string">convert</span><span class="string">\&quot;</span><span class="string">&quot;</span></span>)</span></span>)</span></span>)</span></span>)</span>
      <span class="paren2">(<span class="default">delete-file output-tga-file-name</span>)</span></span>)</span>)

</pre></td></tr>
<tr id="section-6">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-6">&para;</a></div><p>This function is used with maps that contain 3 components (I, Q,
U). It uses the <code>map-&gt;gif</code> function defined below and the
<code>montage</code> program from the ImageMagick suite to create one GIF
file containing the three maps.</p>
</td>
<td class="code">
<pre class="highlight">  <span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> <span class="paren2">(<span class="default">create-3-gifs-and-combine-them input-fits-file-name
					  output-gif-file-name
					  title
					  width</span>)</span>
    <span class="paren2">(<span class="default"><i><span class="symbol">let</span></i> <span class="paren3">(<span class="default"><span class="paren4">(<span class="default">temp-dir <span class="paren5">(<span class="default">create-temporary-directory</span>)</span></span>)</span></span>)</span>
      <span class="paren3">(<span class="default">printf <span class="string">&quot;Creating 3 temporary GIF files in ~a...</span><span class="string">\n</span><span class="string">&quot;</span>
	      temp-dir</span>)</span>
      <span class="paren3">(<span class="default"><i><span class="symbol">let</span></i> <span class="paren4">(<span class="default"><span class="paren5">(<span class="default">I-file-name <span class="paren6">(<span class="default">filepath:join-path <span class="paren1">(<span class="default">list temp-dir <span class="string">&quot;I.gif&quot;</span></span>)</span></span>)</span></span>)</span>
	    <span class="paren5">(<span class="default">Q-file-name <span class="paren6">(<span class="default">filepath:join-path <span class="paren1">(<span class="default">list temp-dir <span class="string">&quot;Q.gif&quot;</span></span>)</span></span>)</span></span>)</span>
	    <span class="paren5">(<span class="default">U-file-name <span class="paren6">(<span class="default">filepath:join-path <span class="paren1">(<span class="default">list temp-dir <span class="string">&quot;U.gif&quot;</span></span>)</span></span>)</span></span>)</span></span>)</span>
	<span class="paren4">(<span class="default">for-each <span class="paren5">(<span class="default"><i><span class="symbol">lambda</span></i> <span class="paren6">(<span class="default">file-name component-number component-name</span>)</span>
		    <span class="paren6">(<span class="default">create-1-gif input-fits-file-name
				  file-name
				  <span class="paren1">(<span class="default">sprintf <span class="string">&quot;~a (~a component)&quot;</span>
					   title component-name</span>)</span>
				  width
				  component-number</span>)</span></span>)</span>
		  <span class="paren5">(<span class="default">list I-file-name Q-file-name U-file-name</span>)</span>
		  <span class="paren5">(<span class="default">list 1           2           3</span>)</span>
		  <span class="paren5">(<span class="default">list <span class="string">&quot;I&quot;</span>         <span class="string">&quot;Q&quot;</span>         <span class="string">&quot;U&quot;</span></span>)</span></span>)</span>
	<span class="paren4">(<span class="default">display <span class="string">&quot;Running &#x27;montage&#x27; on the three GIF images...</span><span class="string">\n</span><span class="string">&quot;</span></span>)</span>
	<span class="paren4">(<span class="default">run <span class="paren5">(<span class="default">montage -tile <span class="string">&quot;1x3&quot;</span>
		      -geometry ,width
		      ,I-file-name
		      ,Q-file-name
		      ,U-file-name
		      ,output-gif-file-name</span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>

</pre></td></tr>
<tr id="section-7">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-7">&para;</a></div><p>This function is simply a nice wrapper for <code>create-1-gif</code> and
<code>create-3-gif-and-combine-them</code>.</p>
</td>
<td class="code">
<pre class="highlight">  <span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> <span class="paren2">(<span class="default">map-&gt;gif input-fits-file-name
		    output-gif-file-name
		    title
		    #!key <span class="paren3">(<span class="default">width 512</span>)</span> <span class="paren3">(<span class="default">overwrite? #f</span>)</span></span>)</span>
    <span class="paren2">(<span class="default">call/cc <span class="comment">; Chicken&#x27;s shortcut for call-with-current-continuation
</span>     <span class="paren3">(<span class="default"><i><span class="symbol">lambda</span></i> <span class="paren4">(<span class="default">return</span>)</span>
</span></span></span></span></span></span></pre></td></tr>
<tr id="section-8">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-8">&para;</a></div><p>Note that, since <code>map2tga</code> does not overwrite existing GIF files,
if the file already exists and the flag <code>overwrite?</code> is true we
first need to delete the file.</p>
</td>
<td class="code">
<pre class="highlight">       <span class="paren1">(<span class="default"><i><span class="symbol">if</span></i> <span class="paren2">(<span class="default">file-exists? output-gif-file-name</span>)</span>
	   <span class="paren2">(<span class="default"><i><span class="symbol">if</span></i> overwrite?
	       <span class="paren3">(<span class="default">delete-file output-gif-file-name</span>)</span>
	       <span class="paren3">(<span class="default">return &#x27;<span class="paren4">(<span class="default"></span>)</span></span>)</span></span>)</span></span>)</span>

</pre></td></tr>
<tr id="section-9">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-9">&para;</a></div><p>Create the directory that will contain the output file,
if it does not exist</p>
</td>
<td class="code">
<pre class="highlight">       <span class="paren1">(<span class="default">create-pathname-directory output-gif-file-name</span>)</span>

</pre></td></tr>
<tr id="section-10">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-10">&para;</a></div><p>If the map contains three components (I, Q, U) we need to
create three GIF files and then combine them into one.</p>
</td>
<td class="code">
<pre class="highlight">       <span class="paren1">(<span class="default"><i><span class="symbol">if</span></i> <span class="paren2">(<span class="default">eq? <span class="paren3">(<span class="default">healpix:num-of-components-in-map input-fits-file-name</span>)</span>
		1</span>)</span>
	   <span class="paren2">(<span class="default">create-1-gif input-fits-file-name
			 output-gif-file-name
			 title
			 width
			 1</span>)</span>
	   <span class="paren2">(<span class="default">create-3-gifs-and-combine-them input-fits-file-name
					   output-gif-file-name
					   title
					   width</span>)</span></span>)</span>)))

</pre></td></tr>
<tr id="section-11">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-11">&para;</a></div><p>This function reads the spectrum/spectra in a FITS file and save
all the data into a CSV file.</p>
</td>
<td class="code">
<pre class="highlight">  <span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> <span class="paren2">(<span class="default">spectrum-&gt;csv input-fits-file-name
			 output-csv-file-name</span>)</span>
    <span class="paren2">(<span class="default"><i><span class="symbol">let*</span></i> <span class="paren3">(<span class="default"><span class="paren4">(<span class="default">columns <span class="paren5">(<span class="default">healpix:read-spectrum input-fits-file-name</span>)</span></span>)</span>
	   <span class="paren4">(<span class="default">num-of-rows <span class="paren5">(<span class="default">f64vector-length <span class="paren6">(<span class="default">car columns</span>)</span></span>)</span></span>)</span></span>)</span>
      <span class="paren3">(<span class="default">printf <span class="string">&quot;Writing CSV file &#x27;~a&#x27;...</span><span class="string">\n</span><span class="string">&quot;</span>
	      output-csv-file-name</span>)</span>
      <span class="paren3">(<span class="default"><i><span class="symbol">with-output-to-file</span></i> output-csv-file-name
	<span class="paren4">(<span class="default"><i><span class="symbol">lambda</span></i> <span class="paren5">(<span class="default"></span>)</span>
	  <span class="paren5">(<span class="default">do <span class="paren6">(<span class="default"><span class="paren1">(<span class="default">row-num 0 <span class="paren2">(<span class="default">+ 1 row-num</span>)</span></span>)</span></span>)</span>
	      <span class="paren6">(<span class="default"><span class="paren1">(<span class="default">&gt;= row-num num-of-rows</span>)</span></span>)</span>
	    <span class="paren6">(<span class="default"><i><span class="symbol">let</span></i> <span class="paren1">(<span class="default"><span class="paren2">(<span class="default">row-elements <span class="paren3">(<span class="default">map <span class="paren4">(<span class="default"><i><span class="symbol">lambda</span></i> <span class="paren5">(<span class="default">column-vector</span>)</span>
				       <span class="paren5">(<span class="default">f64vector-ref column-vector
						      row-num</span>)</span></span>)</span>
				     columns</span>)</span></span>)</span></span>)</span>
	      <span class="paren1">(<span class="default">printf <span class="string">&quot;~a &quot;</span> <span class="paren2">(<span class="default">+ 1 row-num</span>)</span></span>)</span> <span class="comment">; this is ell
</span>	      <span class="paren1">(<span class="default">print <span class="paren2">(<span class="default">string-intersperse <span class="paren3">(<span class="default">map -&gt;string row-elements</span>)</span>
					 <span class="string">&quot; &quot;</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span></span>)</span>

</pre></td></tr>
<tr id="section-12">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-12">&para;</a></div><p>Produce a GIF image containing the spectrum/spectra in a FITS
file. The function invokes <code>gnuplot</code>, which must therefore be in
the <code>PATH</code>.</p>
</td>
<td class="code">
<pre class="highlight">  <span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> <span class="paren2">(<span class="default">spectrum-&gt;gif input-fits-file-name
			 output-gif-file-name
			 title
			 #!key <span class="paren3">(<span class="default">width 512</span>)</span> <span class="paren3">(<span class="default">overwrite? #f</span>)</span></span>)</span>
    <span class="paren2">(<span class="default"><i><span class="symbol">let</span></i> <span class="paren3">(<span class="default"><span class="paren4">(<span class="default">csv-file-name
	   <span class="paren5">(<span class="default">filepath:replace-extension output-gif-file-name <span class="string">&quot;.csv&quot;</span></span>)</span></span>)</span></span>)</span>
</span></span></span></span></pre></td></tr>
<tr id="section-13">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-13">&para;</a></div><p>First step: convert the FITS file into a CSV file (placed
alongside the GIF image under the destination directory)</p>
</td>
<td class="code">
<pre class="highlight">      <span class="paren1">(<span class="default">spectrum-&gt;csv input-fits-file-name csv-file-name</span>)</span>
</pre></td></tr>
<tr id="section-14">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-14">&para;</a></div><p>Now open a output pipe to <code>gnuplot</code> and send the appropriate
commands to plot the spectrum/spectra.</p>
</td>
<td class="code">
<pre class="highlight">      <span class="paren1">(<span class="default"><i><span class="symbol">with-output-to-pipe</span></i>
       <span class="string">&quot;gnuplot&quot;</span>
       <span class="paren2">(<span class="default"><i><span class="symbol">lambda</span></i> <span class="paren3">(<span class="default"></span>)</span>
	 <span class="paren3">(<span class="default">printf #&lt;&lt;EOF
set terminal gif transparent enhanced size ~a, ~a
set output &#x27;~a&#x27;
set logscale y
set xlabel &#x27;l&#x27;
set ylabel &#x27;C_l&#x27;
set title &#x27;~a&#x27;

EOF
                 width
		 <span class="paren4">(<span class="default">inexact-&gt;exact <span class="paren5">(<span class="default">round <span class="paren6">(<span class="default">/ width 1.4</span>)</span></span>)</span></span>)</span>
                 output-gif-file-name
		 title</span>)</span>
	 <span class="paren3">(<span class="default"><i><span class="symbol">if</span></i> <span class="paren4">(<span class="default">eq? <span class="paren5">(<span class="default">healpix:num-of-components-in-spectrum input-fits-file-name</span>)</span>
		  1</span>)</span>
</span></span></span></span></span></span></pre></td></tr>
<tr id="section-15">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-15">&para;</a></div><p><code>then</code> part</p>
</td>
<td class="code">
<pre class="highlight">	     <span class="paren1">(<span class="default">printf <span class="string">&quot;plot &#x27;~a&#x27; using 1:2 with linespoints title &#x27;&#x27;&quot;</span>
		     csv-file-name</span>)</span>
</pre></td></tr>
<tr id="section-16">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-16">&para;</a></div><p><code>else</code> part</p>
</td>
<td class="code">
<pre class="highlight">	     <span class="paren1">(<span class="default">begin
	       <span class="paren2">(<span class="default">printf #&lt;&lt;EOF
plot &#x27;~a&#x27; using 1:2 with lines title &#x27;TT&#x27;, \
     &#x27;~a&#x27; using 1:3 with lines title &#x27;EE&#x27;, \
     &#x27;~a&#x27; using 1:4 with lines title &#x27;BB&#x27;, \
     &#x27;~a&#x27; using 1:3 with lines title &#x27;TE&#x27;, \
     &#x27;~a&#x27; using 1:3 with lines title &#x27;TB&#x27;, \
     &#x27;~a&#x27; using 1:3 with lines title &#x27;EB&#x27; \

EOF
                      csv-file-name
		      csv-file-name
                      csv-file-name
		      csv-file-name
                      csv-file-name
		      csv-file-name</span>)</span></span>)</span>)))))

</pre></td></tr>
<tr id="section-17">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-17">&para;</a></div><p>This function converts the name of a FITS file containing a map
into the name of the <code>.gif</code> file that will contain the
representation of the map shown in the report. It strips the
directory and extension parts and substitutes them using functions
from the <code>filepath</code> eggs. Note that we want the GIF file to be in a
subdirectory of the output directory instead of being in the same
directory as the input FITS file: in this was the user can run
<code>tar</code> or <code>zip</code> on it to obtain a self-contained report.</p>
</td>
<td class="code">
<pre class="highlight">  <span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> <span class="paren2">(<span class="default">fits-name-&gt;gif-name fits-name</span>)</span>
    <span class="paren2">(<span class="default">filepath:replace-directory
     <span class="paren3">(<span class="default">filepath:replace-extension fits-name <span class="string">&quot;.gif&quot;</span></span>)</span>
     <span class="string">&quot;images&quot;</span></span>)</span></span>)</span>

</pre></td></tr>
<tr id="section-18">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-18">&para;</a></div><p>A small set of files (CSS styles, JavaScript files) need to be
copied to the output directory, in order to make the report
self-contained. These files should be taken from the directory
where the executable has been launched.</p>
</td>
<td class="code">
<pre class="highlight">
</pre></td></tr>
<tr id="section-19">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-19">&para;</a></div><p>Chicken Scheme does not provide a function to copy whole
directories. So we implement one using a nice function implemented
in <code>directory-utils</code>: <code>directory-fold</code>. It takes a function to be
applied to each file, a user-defined value that is passed to this
function (we do not use it, so we call it <code>unused</code> and set it to
<code>#f</code>) and the name of the directory.</p>
</td>
<td class="code">
<pre class="highlight">  <span class="paren1">(<span class="default"><i><span class="symbol">define</span></i> <span class="paren2">(<span class="default">dir-copy source dest</span>)</span>
    <span class="paren2">(<span class="default">directory-fold
     <span class="paren3">(<span class="default"><i><span class="symbol">lambda</span></i> <span class="paren4">(<span class="default">filename unused</span>)</span>
       <span class="paren4">(<span class="default"><i><span class="symbol">let</span></i> <span class="paren5">(<span class="default"><span class="paren6">(<span class="default">output-file <span class="paren1">(<span class="default">filepath:join-path <span class="paren2">(<span class="default">list dest filename</span>)</span></span>)</span></span>)</span></span>)</span>
	 <span class="paren5">(<span class="default">format #t <span class="string">&quot;Copying file ~a to ~a...</span><span class="string">\n</span><span class="string">&quot;</span> filename dest</span>)</span>
</span></span></span></span></span></span></span></span></pre></td></tr>
<tr id="section-20">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-20">&para;</a></div><p>Create the destination directory if it does not exist</p>
</td>
<td class="code">
<pre class="highlight">	 <span class="paren1">(<span class="default">create-pathname-directory output-file</span>)</span>
</pre></td></tr>
<tr id="section-21">
<td class="docs">
<div class="pilwrap"><a class="pilcrow" href="#section-21">&para;</a></div><p>Copy the file. <code>file_copy</code> is part of Chicken Scheme</p>
</td>
<td class="code">
<pre class="highlight">	 <span class="paren1">(<span class="default">file-copy <span class="paren2">(<span class="default">filepath:join-path <span class="paren3">(<span class="default">list source filename</span>)</span></span>)</span>
		    output-file
		    &#x27;overwrite</span>)</span>))
     #f <span class="comment">; This is our value for `unused`
</span>     source)))


</pre></td></tr></table></div></body></html>